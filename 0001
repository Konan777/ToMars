ALTER FUNCTION [dbo].[EqpOnSampleDate]
(
	--@SampleTechTestUid GuidList READONLY
	@SampleTechTestUid uniqueidentifier
)

RETURNS TABLE AS RETURN

-- Берем представление v_Eqp за основу. Сохраняем порядок следования колонок. Ограничиваем выборку by SampleTechTestUid.
-- Меняем алгоритм получаения данных по проверкам оборудования. Берем проверку на дату получения образца.
SELECT 
 v_Eqp.[EqpUid], [EqpName], v_Eqp.[EqpTypeUid], [EqpTypeName], [EqpKindId], [EqpStateId], [EqpStateName], [EqpStateActive]
 ,[Limits], [AccuracyClass], [Mnf], [MnfNum], [MnfDate], [InvNum], [Location], [Accuracy], [EngUnitId], [ScaleInterval]
 ,[Purpose], [TechnicalProps], [UserId], [StartUp], [LegalBasis], [Note], [InScopeAccreditation]
 ,[CheckLog].[NextDate]
 ,[EqpCheckType].[Name] AS [CheckTypeName]
 ,[CheckLog].[Doc]
 ,[CheckLog].[DocDate]
 ,[UseOperationControl], [InMetrologyScope], [RV], [EngUnits], [DocExists],[RoomUid]
 ,stte.[SampleTechTestEqpUid], stte.[SampleTechTestUid], stte.[Comment]
from v_Eqp

-- В случае если не нужно оборудование без проверок заменить LEFT JOIN на INNER JOIN
LEFT JOIN (
	-- Найдем действующую на дату образца запись в журнале проверок оборудования
	-- top 1 потому, что может быть несколько записей в ECL подходящих по дате
	select top 1 ECL.* 
	from [dbo].[SampleTechTestEqp] STT2
	inner join [dbo].[EqpCheckLog] ECL on ECL.EqpUid=STT2.EqpUid
	inner join (
		-- Найдем дату образца
		select distinct STTE.SampleTechTestUid, SM.ReceiveDate, SM.SampleId
		from [dbo].[SampleTechTestEqp] STTE
		inner join [dbo].[SampleTechTest] STT on STT.SampleTechTestId=STTE.SampleTechTestUid
		inner join [dbo].[SampleTech] ST on ST.SampleTechId=STT.SampleTechId
		inner join [dbo].[Sample] SM on SM.SampleId=ST.SampleId
		--where STTE.SampleTechTestUid in (SELECT [uid] FROM  @sampleTechTestUid)
		where STTE.SampleTechTestUid = @sampleTechTestUid
	) as SDT on SDT.SampleTechTestUid=STT2.SampleTechTestUid
	--where STT2.SampleTechTestUid in (SELECT [uid] FROM  @sampleTechTestUid)
	where STT2.SampleTechTestUid = @sampleTechTestUid
	and SDT.ReceiveDate>=ECL.DocDate
	and SDT.ReceiveDate<=ECL.NextDate
	order by ECL.Doc desc -- Чтобы подхватилась старшая по дате из нескольких
) AS [CheckLog] ON [CheckLog].[EqpUid] = v_Eqp.EqpUid
LEFT JOIN [dbo].[EqpCheck] ON [EqpCheck].[EqpCheckUid] = [CheckLog].[EqpCheckUid]
LEFT JOIN [dbo].[EqpCheckType] ON [EqpCheckType].[EqpCheckTypeUid] = [EqpCheck].[EqpCheckTypeUid]
inner join SampleTechTestEqp stte on stte.EqpUid= v_Eqp.EqpUid 
	--and stte.SampleTechTestUid in (SELECT [uid] FROM  @sampleTechTestUid)
	and stte.SampleTechTestUid=@sampleTechTestUid







select * from [dbo].[EqpOnSampleDate](cast('82D582F8-05C5-423A-99DB-02F9584E0BE5' as uniqueidentifier)) as z_Eqp
order by z_Eqp.EqpUid



	select top 1 ECL.*
	from [dbo].[SampleTechTestEqp] STT2
	inner join [dbo].[EqpCheckLog] ECL on ECL.EqpUid=STT2.EqpUid
	inner join (
		-- Найдем дату образца
		select distinct STTE.SampleTechTestUid, SM.ReceiveDate, SM.SampleId
		from [dbo].[SampleTechTestEqp] STTE
		inner join [dbo].[SampleTechTest] STT on STT.SampleTechTestId=STTE.SampleTechTestUid
		inner join [dbo].[SampleTech] ST on ST.SampleTechId=STT.SampleTechId
		inner join [dbo].[Sample] SM on SM.SampleId=ST.SampleId
		--where STTE.SampleTechTestUid in (SELECT [uid] FROM  @sampleTechTestUid)
		where STTE.SampleTechTestUid = cast('82D582F8-05C5-423A-99DB-02F9584E0BE5' as uniqueidentifier)
	) as SDT on SDT.SampleTechTestUid=STT2.SampleTechTestUid
	--where STT2.SampleTechTestUid in (SELECT [uid] FROM  @sampleTechTestUid)
	where STT2.SampleTechTestUid = cast('82D582F8-05C5-423A-99DB-02F9584E0BE5' as uniqueidentifier)
	and SDT.ReceiveDate>=ECL.DocDate
	and SDT.ReceiveDate<=ECL.NextDate
	order by ECL.Doc desc



/*
LEFT JOIN (
	SELECT [ca].* FROM (
		SELECT EqpUid, MIN(NextDate) AS nextdate
		FROM [dbo].[EqpCheckLog]
		WHERE NextDate > GETDATE()
		GROUP BY EqpUid
	) AS [MaxDates] CROSS APPLY (
		SELECT TOP 1 * FROM [dbo].[EqpCheckLog]
		WHERE dbo.EqpCheckLog.EqpUid = [MaxDates].EqpUid
		AND EqpCheckLog.NextDate = [MaxDates].nextdate) AS [ca]
) AS [CheckLog] ON [CheckLog].[EqpUid] = [dbo].[Eqp].EqpUid
*/
