-- Проверяем что вернет v_Eqp для нашего случая, или берем все оборудование по которому есть образцы
SELECT distinct v_Eqp.EqpUid, SampleTechTestEqp.SampleTechTestUid
,v_Eqp.Doc, 
CONVERT(varchar,v_Eqp.DocDate,104)+' '+CONVERT(varchar,v_Eqp.DocDate,108) as DocDate,
CONVERT(varchar,v_Eqp.NextDate,104)+' '+CONVERT(varchar,v_Eqp.NextDate,108) as DocDate
FROM v_Eqp
inner join SampleTechTestEqp on v_Eqp.EqpUid=SampleTechTestEqp.EqpUid 
	and NextDate is not null
	and SampleTechTestEqpUid in (
		--select s.SampleId, s.ReceiveDate, stte.EqpUid, stte.SampleTechTestEqpUid  
		select stte.SampleTechTestEqpUid  
		from sample s
		inner join SampleTech st on st.SampleId=s.SampleId
		inner join SampleTechTest stt on stt.SampleTechId=st.SampleTechId
		inner join SampleTechTestEqp stte on stte.SampleTechTestUid=stt.SampleTechTestId
	)
--where SampleTechTestEqp.SampleTechTestEqpUid=''

-- Проверяем что вернет новый скрипт для тестового случая
select EqpUid, Doc, 
CONVERT(varchar,DocDate  ,104)+' '+CONVERT(varchar,DocDate  ,108) as DocDate,
CONVERT(varchar,NextDate  ,104)+' '+CONVERT(varchar,NextDate  ,108) as NextDate,
CONVERT(varchar,CreationDate  ,104)+' '+CONVERT(varchar,CreationDate  ,108) as CreationDate,
SampleId from [dbo].[v_Eqp_by_sample](cast('3DCB89D1-DCE9-4EF8-8CCE-820C5C53FB15' as uniqueidentifier)) z_Eqp

-- список журналов проверок оборудования, с тестированием образца
select Eqp.EqpUid,  
CONVERT(varchar,ecl.DocDate  ,104)+' '+CONVERT(varchar,ecl.DocDate  ,108) as DocDate,
CONVERT(varchar,ecl.NextDate  ,104)+' '+CONVERT(varchar,ecl.NextDate  ,108) as CheckDate,
ecl.Doc, ecl.EqpCheckLogUid, ecl.EqpCheckUid
from Eqp 
inner join EqpCheckLog ecl on ecl.EqpUid=Eqp.EqpUid
LEFT JOIN [EqpCheck] ec ON ec.[EqpCheckUid] = ecl.[EqpCheckUid]
where exists(
	select * from SampleTechTestEqp stt where stt.EqpUid=Eqp.EqpUid
) and year(ecl.DocDate)<>year(ecl.NextDate)
--and Eqp.EqpUid='CD78AD36-3894-4C92-8DA7-D1B7C71BC1E5'
order by ecl.EqpUid, ecl.DocDate desc

-- Убийца на замену
LEFT JOIN (
	-- Найдем действующую на дату образца запись в журнале проверок оборудования
	select distinct ECL.*, SDT.SampleId, SDT.CreationDate
	from [dbo].[SampleTechTestEqp] STTE
	inner join [dbo].[Eqp] EPQ on EPQ.[EqpUid]=STTE.EqpUid
	inner join [dbo].[EqpCheckLog] ECL on ECL.EqpUid=EPQ.EqpUid
	inner join [dbo].[EqpCheck] EC on EC.[EqpCheckUid]=ECL.[EqpCheckUid]
	inner join (
		-- Найдем дату образца
		select distinct STTE.SampleTechTestUid, SM.CreationDate, SM.SampleId
		from [dbo].[SampleTechTestEqp] STTE
		inner join [dbo].[SampleTechTest] STT on STT.SampleTechTestId=STTE.SampleTechTestUid
		inner join [dbo].[SampleTech] ST on ST.SampleTechId=STT.SampleTechId
		inner join [dbo].[Sample] SM on SM.SampleId=ST.SampleId
		where STTE.SampleTechTestUid = @sampleTechTestUid
			--in (SELECT [uid] FROM  @sampleTechTestUid)
	) as SDT on SDT.SampleTechTestUid=STTE.SampleTechTestUid
	where STTE.SampleTechTestUid = @sampleTechTestUid
		--in (SELECT [uid] FROM  @sampleTechTestUid)
	and SDT.CreationDate>=ECL.DocDate
	and SDT.CreationDate<=ECL.NextDate
) AS [CheckLog] ON [CheckLog].[EqpUid] = [dbo].[Eqp].EqpUid 

