
                    Лаборатория. Subdivisions.

Список продуктов выбираем на: Лабораторию и группу продуктов 

Поиск точки контроля:

declare
	@SubdivisionUid uniqueidentifier
	,@ProductGroupId int
	,@ProductUid uniqueidentifier

set @ProductUid=cast('0A19EC21-EE6B-4509-93DB-9231CCE6A05F' as uniqueidentifier);
set @ProductGroupId=266;

select
	[CP].CPUid 
	,[CP].Name
	,[CP].Code
	,[Product].ProductUid
	,[ProductGroup].ProductGroupId
	,[Subdivision].SubdivisionUid
from [dbo].[CP]
INNER JOIN [dbo].[CPProduct] on [CPProduct].CPUid=[CP].CPUid
INNER JOIN [dbo].[Product] on [Product].ProductUid=[CPProduct].ProductUid
LEFT JOIN [dbo].[ProductGroupContent] on [ProductGroupContent].ProductUid=[Product].ProductUid
LEFT JOIN [dbo].[ProductGroup] on [ProductGroup].ProductGroupId=[ProductGroupContent].ProductGroupId
LEFT JOIN [dbo].[SubdivisionProduct] on [SubdivisionProduct].ProductUid=[Product].ProductUid
LEFT JOIN [dbo].[Subdivision] on [Subdivision].SubdivisionId=[SubdivisionProduct].SubdivisionId
where (@SubdivisionUid is null or (@SubdivisionUid is not null and [Subdivision].SubdivisionUid=@SubdivisionUid))
	and (@ProductGroupId is null or (@ProductGroupId is not null and [ProductGroup].ProductGroupId=@ProductGroupId))
	and (@ProductUid is null or (@ProductUid is not null and [Product].ProductUid=@ProductUid))




        private void InitProductGroups()
        {
            var pGroups = _glSubdivision.EditValue is int
                ? SA.Instance.GetProductGroupsBySubdivision((int)_glSubdivision.EditValue).ToArray()
                : new ProductGroup[0];

            _glProductGroup.Properties.DataSource = pGroups;
            _glProductGroup.Enabled = pGroups.Any();
            if (_glProductGroup.EditValue != null && pGroups.All(a => (int)_glProductGroup.EditValue != a.ProductGroupId))
                _glProductGroup.EditValue = null;

            InitProducts();
        }


        private void InitProducts()
        {
            var products = _glSubdivision.EditValue is int
                ? SA.Instance.GetProductsBySubdivision((int)_glSubdivision.EditValue).Where(a => a.IsActive).ToArray()
                : new Product[0];

            if (_glProductGroup.EditValue is int)
            {
                var pGroup = SA.Instance.GetProductGroup((int)_glProductGroup.EditValue);
                if (pGroup != null)
                {
                    products = products.Where(a => pGroup.ProductGroupContents.Any(b => b.ProductUid == a.ProductUid)).ToArray();
                }
            }

            _glProduct.Properties.DataSource = products;
            _glProduct.Enabled = products.Any();
            if (_glProduct.EditValue != null && products.All(a => (Guid)_glProduct.EditValue != a.ProductUid))
                _glProduct.EditValue = null;

            InitTechs();
        }
