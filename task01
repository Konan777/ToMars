1) Откуда идут данные в документ?

В случае если из v_eqp:
При выборе дат проверки оборудования нам неизвестен образец и его дата
1) переписать v_eqp чтобы на вход подавались SampleTechTestEqp.SampleTechTestUid
  потом идти на SampleTechTestEqp->SampleTechTest->SampleTech->Sample за датой образца
  потом идти в EqpCheckLog и сворачивать выборку  [NextDate], [Doc], [DocDate]
2) пишем табличную функицю которая для набора SampleTechTestUid которая вернет три поля
  затем апдейтить поля в нужной таблице в приложении


-- список журналов проверок оборудования, с тестированием образца
select Eqp.EqpUid,  
CONVERT(varchar,ecl.DocDate  ,104)+' '+CONVERT(varchar,ecl.DocDate  ,108) as DocDate,
CONVERT(varchar,ecl.NextDate  ,104)+' '+CONVERT(varchar,ecl.NextDate  ,108) as CheckDate,
ecl.Doc, ecl.EqpCheckLogUid, ecl.EqpCheckUid
from Eqp 
inner join EqpCheckLog ecl on ecl.EqpUid=Eqp.EqpUid
LEFT JOIN [EqpCheck] ec ON ec.[EqpCheckUid] = ecl.[EqpCheckUid]
where exists(
	select * from SampleTechTestEqp stt where stt.EqpUid=Eqp.EqpUid
) and year(ecl.DocDate)<>year(ecl.NextDate)
--and ecl.EqpCheckUid='CFC4F3B2-F389-4FF5-8C10-CD946DB010B3'
order by ecl.EqpUid, ecl.DocDate desc

-- Находим образец проверенные с помощью оборудования
-- Три первые колонки для поиска образца
-- SampleTechTestUid для выборки выше
select distinct sm.SampleId, sm.code, 
CONVERT(varchar,sm.CreationDate,104)+' '+CONVERT(varchar,sm.CreationDate,108) as CreationDate,
mix.SampleTechTestUid from (
select stt.SampleTechTestEqpUid, stt.SampleTechTestUid  from Eqp 
inner join EqpCheckLog ecl on ecl.EqpUid=Eqp.EqpUid
LEFT JOIN [EqpCheck] ec ON ec.[EqpCheckUid] = ecl.[EqpCheckUid]
left join SampleTechTestEqp stt on stt.EqpUid=Eqp.EqpUid
where ecl.EqpCheckUid='CFC4F3B2-F389-4FF5-8C10-CD946DB010B3' and stt.SampleTechTestEqpUid is not null
) mix
inner join SampleTechTest stt on stt.SampleTechTestId=mix.SampleTechTestUid
inner join SampleTech st on stt.SampleTechId=st.SampleTechId
inner join [Sample] sm on sm.SampleId=st.SampleId
order by CreationDate

-- Проверяем что вернет v_Eqp для нашего случая
SELECT distinct v_Eqp.EqpUid, SampleTechTestEqp.SampleTechTestUid
,v_Eqp.Doc, 
CONVERT(varchar,v_Eqp.DocDate,104)+' '+CONVERT(varchar,v_Eqp.DocDate,108) as DocDate,
CONVERT(varchar,v_Eqp.NextDate,104)+' '+CONVERT(varchar,v_Eqp.NextDate,108) as DocDate
FROM v_Eqp
inner join SampleTechTestEqp on v_Eqp.EqpUid=SampleTechTestEqp.EqpUid 
	and NextDate is not null
	and SampleTechTestEqpUid in (
		--select s.SampleId, s.ReceiveDate, stte.EqpUid, stte.SampleTechTestEqpUid  
		select stte.SampleTechTestEqpUid  
		from sample s
		inner join SampleTech st on st.SampleId=s.SampleId
		inner join SampleTechTest stt on stt.SampleTechId=st.SampleTechId
		inner join SampleTechTestEqp stte on stte.SampleTechTestUid=stt.SampleTechTestId
	)
--where SampleTechTestEqp.SampleTechTestEqpUid=''

