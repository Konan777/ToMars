use [I-LDS_2]
go
drop function [dbo].[fun_test_tabl]  
go
CREATE FUNCTION [dbo].[fun_test_tabl]  
(	
	@date datetime
)
RETURNS TABLE 
AS
RETURN 
(
	SELECT * from v_Eqp where DocDate>=@date
)
GO

LEFT JOIN (
	SELECT [ca].* FROM (
		SELECT EqpUid, MIN(NextDate) AS nextdate FROM [dbo].[EqpCheckLog]
		WHERE NextDate > GETDATE()
		GROUP BY EqpUid) AS [MaxDates]
		CROSS APPLY (
			SELECT TOP 1 * FROM [dbo].[EqpCheckLog]
			WHERE dbo.EqpCheckLog.EqpUid = [MaxDates].EqpUid
			AND EqpCheckLog.NextDate = [MaxDates].nextdate
		) AS [ca]
) AS [CheckLog]ON [CheckLog].[EqpUid] = [dbo].[Eqp].EqpUid
