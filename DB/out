
	-- Маппинг на основе Hostname/Mobile/Pps
	UPDATE		[crm].[Registrations]
	SET			[AtomId]		= BR.[AtomId],
				[Version]		= BR.[Version],
				[BindingRuleId] = 'Pps:' + Cast(BR.[BindingRuleId] as nvarchar)
	FROM		(
		-- [Hostname]
		SELECT REG.[id], BR.[AtomId], BR.[Version], BR.[Id] as [BindingRuleId]
		FROM [crm].[Registrations] REG
		INNER JOIN [crm].[BindingRules] BR ON BR.[Hostname]=REG.[Hostname]
		WHERE REG.[DateTime] >= @startDate AND REG.[DateTime] < @endDatePlusOneDay
			AND REG.[Hostname] IS NOT NULL 
			AND REG.[AtomId] IS NULL	-- Не трогаем ранее примапленные записи	

		UNION ALL
		-- [Mobile]
		SELECT REG.[id], BR.[AtomId], BR.[Version], BR.[Id] as [BindingRuleId]
		FROM [crm].[Registrations] REG
		INNER JOIN [crm].[BindingRules] BR ON BR.[Mobile]=REG.[Mobile]
		WHERE REG.[DateTime] >= @startDate AND REG.[DateTime] < @endDatePlusOneDay
			AND REG.[Mobile] IS NOT NULL 
			AND REG.[AtomId] IS NULL	-- Не трогаем ранее примапленные записи	

		UNION ALL

		SELECT REG.[id], BR.[AtomId], BR.[Version], BR.[Id] as [BindingRuleId]
		FROM [crm].[Registrations] REG
		INNER JOIN [crm].[BindingRules] BR ON BR.[Pps]=REG.[Pps]
		WHERE REG.[DateTime] >= @startDate AND REG.[DateTime] < @endDatePlusOneDay
			AND (REG.[Hostname] IS NULL AND REG.[Mobile] IS NULL)
			AND REG.[Pps] IS NOT NULL
			AND REG.[AtomId] IS NULL	-- Не трогаем ранее примапленные записи	

	)	AS Br
	INNER JOIN	[crm].[Registrations] AS A ON Br.[Id] = A.[Id] 

	SELECT * from [crm].[Registrations] where REG.[Hostname] IS NOT NULL AND REG.[Mobile] IS NOT NULL AND REG.[Pps] IS NOT NULL 






ALTER PROCEDURE [client].[MapAtomsFixedBets] (@startDate DATE, @endDate DATE)
AS
BEGIN
	SET NOCOUNT ON

	DECLARE @endDatePlusOneDay DATE
	SELECT @endDatePlusOneDay = DATEADD(DAY, 1, @endDate)

	-- Сбросим маппинг для указанного диапазона дат
	UPDATE [crm].[FixedBets] SET [AtomId]=NULL, [Version]=NULL, [BindingRuleId]=NULL
	WHERE [DateTime] >= @startDate AND [DateTime] < @endDatePlusOneDay

	DECLARE @reactivationDays [INT] = 90

	-- Собираем сюдой все реактивации (записи с интервалом между ставками >=@reactivationDays)
	DECLARE @t TABLE
	(
		[Id]				BIGINT			NOT NULL,
		[UserId]			[NVARCHAR](20)	NOT NULL,
		[Value]				[NVARCHAR](200) NOT NULL,
		[IsSite]			[BIT]			NULL,
		[IsMobile]			[BIT]			NULL,
		[SEO_Date]			[DateTime]		NULL,
		[DaysFromPrevBet]	[INT]			NULL,
		[Reg]				[BIT]			NULL,	-- Регистрации
		[AtomId]			[INT]			NULL,
		[Version]			[INT]			NULL,
		[BindingRuleId]		[NVARCHAR](300)	NULL

	)

	-- Найдем все реактивации для записей у которых есть Registrations но нет авторизации в [SeoUsersRefs]
	INSERT INTO @t
			([Id], [UserId], [Value], [IsSite], [IsMobile], [SEO_Date], [DaysFromPrevBet], [Reg])
	SELECT [Id], [UserId], NULL AS [Value], NULL AS IsSite, NULL AS IsMobile, NULL AS [SEO_Date], [DaysFromPrevBet], 1 AS [REG]
		--FB_Date, SEO_ID,  Prev_FB_Date, DaysFromSeo, IsSite, IsMobile, SEO_Date, DaysFromPrevBet
	FROM (
			SELECT [Id], [UserId], NULL AS [AtomId], NULL AS [Version], NULL AS [BindingRuleId], DaysFromPrevBet
			FROM (
				SELECT [Id], [UserId], REG_Date, FB_Date, DaysFromReg, Prev_FB_Date, 
					DATEDIFF(DAY, ISNULL(Prev_FB_Date, REG_Date), FB_Date) DaysFromPrevBet
				FROM (
					select FB.[Id], FB.[UserId], REG.[DateTime] REG_Date, FB.[DateTime] FB_Date
						, DATEDIFF(DAY, REG.[DateTime], FB.[DateTime]) DaysFromReg
						, LAG(FB.[DateTime]) OVER (PARTITION BY FB.[UserId] ORDER BY FB.[DateTime]) Prev_FB_Date
					FROM [crm].[FixedBets] FB
					INNER JOIN [crm].[Registrations] REG ON REG.[UserId]=FB.[UserId]
					WHERE FB.[DateTime] >= @startDate AND FB.[DateTime] < @endDatePlusOneDay
						AND NOT EXISTS (SELECT ID FROM [crm].[SeoUsersRefs] SEO where REG.[UserId]=SEO.[UserId])
				) as FR
			) AS QR
			WHERE DaysFromPrevBet>@reactivationDays
	) AS WW

	-- Найдем реактивации для записей у которых нет [Registrations] но есть авторизация в [SeoUsersRefs] AND IsMobile=1
	INSERT INTO @t
				([Id], [UserId], [Value], [IsSite], [IsMobile], [SEO_Date], [DaysFromPrevBet], [Reg])
	SELECT [Id], [UserId], [Value], IsSite, IsMobile, [SEO_Date], [DaysFromPrevBet], 0 AS [Reg]
		--FB_Date, SEO_ID,  Prev_FB_Date, DaysFromSeo, IsSite, IsMobile, SEO_Date, DaysFromPrevBet
	FROM (
		select [Id], [UserId], FB_Date, SEO_ID,  Prev_FB_Date, DaysFromSeo, IsSite, IsMobile, SEO_Date, [Value]
			,DATEDIFF(DAY, ISNULL(Prev_FB_Date, SEO_Date), FB_Date) [DaysFromPrevBet]
			,ROW_NUMBER() OVER (PARTITION BY [UserId] ORDER BY SEO_DATE desc) AS [RowNumber]
			-- ^^^ берем сессию ближайжую к ставке по дате
		FROM (
			select WB.[Id], WB.[UserId], FB_Date, SEO.[Id] SEO_ID, SEO.[DateTime] as SEO_Date, Prev_FB_Date, IsSite, IsMobile, SEO.[Value] AS [Value]
				,DATEDIFF(DAY, SEO.[DateTime], FB_Date) DaysFromSeo
			FROM (
				select FB.[Id], FB.[UserId], FB.[DateTime] FB_Date, FB.IsSite, FB.IsMobile
					, LAG(FB.[DateTime]) OVER (PARTITION BY FB.[UserId] ORDER BY FB.[DateTime]) Prev_FB_Date
				FROM [crm].[FixedBets] FB
				WHERE NOT EXISTS (SELECT ID FROM [crm].[Registrations] REG where REG.[UserId]=FB.[UserId])
					AND FB.[DateTime] >= @startDate AND FB.[DateTime] < @endDatePlusOneDay
			) WB 
			INNER JOIN [crm].[SeoUsersRefs] SEO ON SEO.UserId=WB.[UserId] AND SEO.DateTime<=FB_Date
	
		) QB
		WHERE DATEDIFF(DAY, ISNULL(Prev_FB_Date, SEO_Date), FB_Date)>@reactivationDays
	) WW
	WHERE [RowNumber]=1

	DECLARE 
		@rows01 [INT] = (SELECT COUNT(*) FROM @T WHERE Reg=1)
		, @rows02 [INT] = (SELECT COUNT(*) FROM @T WHERE Reg=0)
	PRINT 'Реактиваций по регистрации:'+CAST(@rows01 AS NVARCHAR)
	PRINT 'Реактиваций по SeoUserRef:'+CAST(@rows02 AS NVARCHAR)


	-- Подхватим атомы из AnalyticsSessions (для [Registrations])
	UPDATE		@t
	SET			[AtomId]		= BR.[AtomId],
				[Version]		= BR.[Version],
				[BindingRuleId] = 'AnalyticsSessions:' + Cast(BR.[BindingRuleId] as nvarchar)
	FROM		(
		-- Поиск реактивации для [Registrations]
		SELECT [Id], [AtomId], [Version], [BindingRuleId], [RowNumber], DaysFromPrevBet
		FROM (
			SELECT TT.[Id], GAS.[AtomId], GAS.[Version], GAS.[BindingRuleId], DaysFromPrevBet
				--[UserId], REG_Date, FB_Date, DaysFromReg, Prev_FB_Date, DaysFromPrevBet, GAS.[DateTime]
				,ROW_NUMBER() OVER (PARTITION BY [UserId] ORDER BY GAS.[DateTime] DESC) AS [RowNumber]
			FROM @t AS TT
			INNER JOIN [core].[AnalyticsSessions] GAS ON GAS.[Custom3]=[UserId]
			WHERE DaysFromPrevBet>@reactivationDays
				AND TT.[Reg]=1
		) AS WR
		WHERE [RowNumber]=1 -- Ближайшая по дате и времени запись в ГА к сессии 

	) AS Br
	INNER JOIN	@t	AS A ON Br.[Id] = A.[Id] 


	-- Подхватим атомы для IsMobile=1 по [AnalyticsSessions]
	UPDATE		@t
	SET			[AtomId]		= BR.[AtomId],
				[Version]		= BR.[Version],
				[BindingRuleId] = 'AnalyticsSessions:' + Cast(BR.[BindingRuleId] as nvarchar)
	FROM		(
		SELECT [Id], [AtomId], [Version], [BindingRuleId], [DaysFromPrevBet]
			--, [SEO_Date], [GAS_Date]
		FROM (

			SELECT PT.[Id], GAS.[AtomId], GAS.[Version], GAS.[BindingRuleId], [IsMobile], [DaysFromPrevBet]
				--[UserId], [Value], [IsSite], [IsMobile], [SEO_Date], GAS.[DateTime] AS [GAS_Date]
				,ROW_NUMBER() OVER (PARTITION BY [UserId] ORDER BY GAS.[DateTime] DESC) AS [RowNumber]
			FROM @t AS PT
			INNER JOIN [core].[AnalyticsSessions] GAS ON 'GA1.2.'+GAS.[ClientId]=[Value]
			WHERE GAS.[DateTime]<=[SEO_Date]	-- отбросим сессии ранее первой авторизации 
				AND [IsMobile]=1
				AND PT.[Reg]=0

			UNION ALL

			SELECT PT.[Id], GAS.[AtomId], GAS.[Version], GAS.[BindingRuleId], [IsMobile], [DaysFromPrevBet]
				--[UserId], [Value], [IsSite], [IsMobile], [SEO_Date], GAS.[DateTime] AS [GAS_Date]
				,ROW_NUMBER() OVER (PARTITION BY [UserId] ORDER BY GAS.[DateTime] DESC) AS [RowNumber]
			FROM @t AS PT
			INNER JOIN [core].[AnalyticsSessions] GAS ON GAS.[Custom3]=[UserId]
			WHERE GAS.[DateTime]<=[SEO_Date]	-- отбросим сессии ранее первой авторизации 
				AND [IsMobile]=1
				AND PT.[Reg]=0

		) AS SB
		WHERE [RowNumber]=1
			
	)	AS Br
	INNER JOIN	@t	AS A ON Br.[Id] = A.[Id] 

	-- Подхватим атомы для записи без атомов по PpsName
	UPDATE		@t
	SET			[AtomId]		= BR.[AtomId],
				[Version]		= BR.[Version],
				[BindingRuleId] = 'Pps:' + Cast(BR.[BindingRuleId] as nvarchar)
	FROM		(
		SELECT [Id], [AtomId], [Version], [BindingRuleId], [DaysFromPrevBet]
		FROM (

			SELECT PT.[Id], BR.[AtomId], BR.[Version], BR.[Id] AS [BindingRuleId], [DaysFromPrevBet]
			FROM @t AS PT
			INNER JOIN [crm].[FixedBets] FB ON FB.AtomId=PT.Id
			INNER JOIN [crm].[BindingRules] BR ON BR.[Pps]=FB.[PpsName]
			
		) AS SB
	) AS br
	INNER JOIN	@t	AS A ON Br.[Id] = A.[Id] 
	WHERE A.[AtomId] IS NULL

	-- Апдейтим реактивации 
	UPDATE		[crm].[FixedBets]	
	SET			[AtomId]		= ISNULL(T.[AtomId], 0),
				[Version]		= ISNULL(T.[Version], 1),
				[BindingRuleId] = T.[BindingRuleId],
				[ReactivatedDays] = DaysFromPrevBet
	FROM		[crm].[FixedBets]	AS A
	INNER JOIN	@t							AS T ON A.[Id] = T.[Id]

	SET @rows01 = (SELECT COUNT(*) FROM @T WHERE Reg=1 AND AtomId IS NOT NULL)
	SET @rows02 = (SELECT COUNT(*) FROM @T WHERE Reg=0 AND AtomId IS NOT NULL)
	PRINT 'Найдено атомов для реактиваций по регистрации:'+CAST(@rows01 AS NVARCHAR)
	PRINT 'Найдено атомов реактиваций по SeoUserRef:'+CAST(@rows02 AS NVARCHAR)

	-- Маппинг записей не являющихся реактивацией. Атомы берем из Registration
	UPDATE		[crm].[FixedBets]	
	SET			[AtomId]		= ISNULL(REG.[AtomId], 0),
				[Version]		= ISNULL(REG.[Version], 1),
				[BindingRuleId] = REG.[BindingRuleId]
	FROM		[crm].[FixedBets]	AS A
	INNER JOIN	[crm].[Registrations] AS REG ON REG.[UserId]=A.[UserId]
	WHERE A.[AtomId] IS NULL AND REG.[AtomId] IS NOT NULL


END
