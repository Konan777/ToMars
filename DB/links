https://scottiestech.info/2015/11/12/fix-uefi-bios-boot-problems-on-a-new-motherboard/

CREATE VIEW [pivotparts].[Profit]
AS
SELECT 	[Дата], [AtomId], [Version]
		, SUM([Доход, руб]) AS [Доход, руб]
		, SUM([Депозиты, руб]) AS [Депозиты, руб]
		, SUM([Депозит, шт]) AS [Депозит, шт]
		, SUM([Первый депозит, руб]) AS [Первый депозит, руб]
		, SUM([Первый депозит, шт]) AS [Первый депозит, шт]
		, SUM([Общий оборот за период]) AS [Общий оборот за период]
		, SUM([Пользователи]) AS [Пользователи]
		, SUM([Доход, руб ВАЛ]) AS [Доход, руб ВАЛ]
		, SUM([Депозиты, руб ВАЛ]) AS [Депозиты, руб ВАЛ]
		, SUM([Депозит, шт ВАЛ]) AS [Депозит, шт ВАЛ]
		, SUM([Первый депозит, руб ВАЛ]) AS [Первый депозит, руб ВАЛ]
		, SUM([Первый депозит, шт ВАЛ]) AS [Первый депозит, шт ВАЛ]
		, SUM([Общий оборот за период, ВАЛ]) AS [Общий оборот за период, ВАЛ]
		, SUM([Пользователи ВАЛ]) AS [Пользователи ВАЛ]
FROM (
	-- Доход, руб
	SELECT 
		CAST(REG.[DateTime] AS DATE) AS [Дата]
		, [AtomId] 
		, [Version]
		, SUM(PRO.[ProfitValue]) AS [Доход, руб]
		, 0 AS [Депозиты, руб]
		, 0 AS [Депозит, шт]
		, 0 AS [Первый депозит, руб]
		, 0 AS [Первый депозит, шт]
		, 0 AS [Общий оборот за период]
		, 0 AS [Пользователи]
		, 0 AS [Доход, руб ВАЛ]
		, 0 AS [Депозиты, руб ВАЛ]
		, 0 AS [Депозит, шт ВАЛ]
		, 0 AS [Первый депозит, руб ВАЛ]
		, 0 AS [Первый депозит, шт ВАЛ]
		, 0 AS [Общий оборот за период, ВАЛ]
		, 0 AS [Пользователи ВАЛ]
	FROM [crm].[UserRegistrations] REG 
	INNER JOIN [crm].[Profits] PRO ON PRO.UserId=REG.UserId
	GROUP BY CAST(REG.[DateTime] AS DATE), [AtomId], [Version]

	UNION ALL

	-- [Депозиты, руб]
	SELECT 
		CAST(REG.[DateTime] AS DATE) AS [Дата]
		, [AtomId] 
		, [Version]
		, 0 AS [Доход, руб]
		, SUM(Amount) AS [Депозиты, руб]
		, 0 AS [Депозит, шт]
		, 0 AS [Первый депозит, руб]
		, 0 AS [Первый депозит, шт]
		, 0 AS [Общий оборот за период]
		, 0 AS [Пользователи]
		, 0 AS [Доход, руб ВАЛ]
		, 0 AS [Депозиты, руб ВАЛ]
		, 0 AS [Депозит, шт ВАЛ]
		, 0 AS [Первый депозит, руб ВАЛ]
		, 0 AS [Первый депозит, шт ВАЛ]
		, 0 AS [Общий оборот за период, ВАЛ]
		, 0 AS [Пользователи ВАЛ]
	FROM [crm].[UserRegistrations] REG 
	INNER JOIN [crm].[Payments] PRO ON PRO.UserId=REG.UserId
	WHERE PRO.Direction=0 AND PRO.Bonus=0
	GROUP BY CAST(REG.[DateTime] AS DATE), [AtomId], [Version]
	
	UNION ALL

	-- [Депозит, шт]
	SELECT 
		CAST(REG.[DateTime] AS DATE) AS [Дата]
		, [AtomId] 
		, [Version]
		, 0 AS [Доход, руб]
		, 0 AS [Депозиты, руб]
		, COUNT(*) AS [Депозит, шт]
		, 0 AS [Первый депозит, руб]
		, 0 AS [Первый депозит, шт]
		, 0 AS [Общий оборот за период]
		, 0 AS [Пользователи]
		, 0 AS [Доход, руб ВАЛ]
		, 0 AS [Депозиты, руб ВАЛ]
		, 0 AS [Депозит, шт ВАЛ]
		, 0 AS [Первый депозит, руб ВАЛ]
		, 0 AS [Первый депозит, шт ВАЛ]
		, 0 AS [Общий оборот за период, ВАЛ]
		, 0 AS [Пользователи ВАЛ]
	FROM [crm].[UserRegistrations] REG 
	INNER JOIN [crm].[Payments] PRO ON PRO.UserId=REG.UserId
	WHERE PRO.Direction=0 AND PRO.Bonus=0
	GROUP BY CAST(REG.[DateTime] AS DATE), [AtomId], [Version]
	
	UNION ALL

	-- [Первый депозит, руб]
	SELECT 
		CAST(REG.[DateTime] AS DATE) AS [Дата]
		, [AtomId] 
		, [Version]
		, 0 AS [Доход, руб]
		, 0 AS [Депозиты, руб]
		, 0 AS [Депозит, шт]
		, SUM(Amount) AS [Первый депозит, руб]
		, 0 AS [Первый депозит, шт]
		, 0 AS [Общий оборот за период]
		, 0 AS [Пользователи]
		, 0 AS [Доход, руб ВАЛ]
		, 0 AS [Депозиты, руб ВАЛ]
		, 0 AS [Депозит, шт ВАЛ]
		, 0 AS [Первый депозит, руб ВАЛ]
		, 0 AS [Первый депозит, шт ВАЛ]
		, 0 AS [Общий оборот за период, ВАЛ]
		, 0 AS [Пользователи ВАЛ]
	FROM [crm].[UserRegistrations] REG 
	INNER JOIN [crm].[Payments] PRO ON PRO.UserId=REG.UserId
	INNER JOIN (
		-- Только первые записи пользователя в [Payments]
		SELECT ID FROM (
			SELECT Id, [UserId], [DateTime], ROW_NUMBER() OVER (PARTITION BY [UserId] ORDER BY DateTime) AS [RowNumber]
			FROM [crm].[Payments]
		) FD
		WHERE [RowNumber]=1		
	) FR ON FR.ID=PRO.ID
	WHERE PRO.Direction=0 AND PRO.Bonus=0
	GROUP BY CAST(REG.[DateTime] AS DATE), [AtomId], [Version]

	UNION ALL

	-- [Первый депозит, шт]
	SELECT 
		CAST(REG.[DateTime] AS DATE) AS [Дата]
		, [AtomId] 
		, [Version]
		, 0 AS [Доход, руб]
		, 0 AS [Депозиты, руб]
		, 0 AS [Депозит, шт]
		, 0 AS [Первый депозит, руб]
		, COUNT(*) AS [Первый депозит, шт]
		, 0 AS [Общий оборот за период]
		, 0 AS [Пользователи]
		, 0 AS [Доход, руб ВАЛ]
		, 0 AS [Депозиты, руб ВАЛ]
		, 0 AS [Депозит, шт ВАЛ]
		, 0 AS [Первый депозит, руб ВАЛ]
		, 0 AS [Первый депозит, шт ВАЛ]
		, 0 AS [Общий оборот за период, ВАЛ]
		, 0 AS [Пользователи ВАЛ]
	FROM [crm].[UserRegistrations] REG 
	INNER JOIN [crm].[Payments] PRO ON PRO.UserId=REG.UserId
	INNER JOIN (
		-- Только первые записи пользователя в [Payments]
		SELECT ID FROM (
			SELECT Id, [UserId], [DateTime], ROW_NUMBER() OVER (PARTITION BY [UserId] ORDER BY DateTime) AS [RowNumber]
			FROM [crm].[Payments]
		) FD
		WHERE [RowNumber]=1		
	) FR ON FR.ID=PRO.ID
	WHERE PRO.Direction=0 AND PRO.Bonus=0
	GROUP BY CAST(REG.[DateTime] AS DATE), [AtomId], [Version]
	
	UNION ALL

	-- [Общий оборот за период]
	SELECT 
		CAST(REG.[DateTime] AS DATE) AS [Дата]
		, [AtomId] 
		, [Version]
		, 0 AS [Доход, руб]
		, 0 AS [Депозиты, руб]
		, 0 AS [Депозит, шт]
		, 0 AS [Первый депозит, руб]
		, 0 AS [Первый депозит, шт]
		, SUM(Amount) AS [Общий оборот за период]
		, 0 AS [Пользователи]
		, 0 AS [Доход, руб ВАЛ]
		, 0 AS [Депозиты, руб ВАЛ]
		, 0 AS [Депозит, шт ВАЛ]
		, 0 AS [Первый депозит, руб ВАЛ]
		, 0 AS [Первый депозит, шт ВАЛ]
		, 0 AS [Общий оборот за период, ВАЛ]
		, 0 AS [Пользователи ВАЛ]
	FROM [crm].[UserRegistrations] REG 
	INNER JOIN [crm].[FixedBets] PRO ON PRO.UserId=REG.UserId
	GROUP BY CAST(REG.[DateTime] AS DATE), [AtomId], [Version]

	UNION ALL

	-- [Пользователи]
	SELECT 
		CAST(REG.[DateTime] AS DATE) AS [Дата]
		, [AtomId] 
		, [Version]
		, 0 AS [Доход, руб]
		, 0 AS [Депозиты, руб]
		, 0 AS [Депозит, шт]
		, 0 AS [Первый депозит, руб]
		, 0 AS [Первый депозит, шт]
		, 0 AS [Общий оборот за период]
		, COUNT(*) AS [Пользователи]
		, 0 AS [Доход, руб ВАЛ]
		, 0 AS [Депозиты, руб ВАЛ]
		, 0 AS [Депозит, шт ВАЛ]
		, 0 AS [Первый депозит, руб ВАЛ]
		, 0 AS [Первый депозит, шт ВАЛ]
		, 0 AS [Общий оборот за период, ВАЛ]
		, 0 AS [Пользователи ВАЛ]
	FROM [crm].[UserRegistrations] REG 
	INNER JOIN (
		SELECT DISTINCT UserId FROM [crm].[FixedBets]
	) PRO ON PRO.UserId=REG.UserId
	GROUP BY CAST(REG.[DateTime] AS DATE), [AtomId], [Version]

	UNION ALL

	-- [Доход, руб ВАЛ]
	SELECT 
		CAST(PRO.[DateTime] AS DATE) AS [Дата]
		, [AtomId] 
		, [Version]
		, 0 AS [Доход, руб]
		, 0 AS [Депозиты, руб]
		, 0 AS [Депозит, шт]
		, 0 AS [Первый депозит, руб]
		, 0 AS [Первый депозит, шт]
		, 0 AS [Общий оборот за период]
		, 0 AS [Пользователи]
		, SUM(PRO.[ProfitValue]) AS [Доход, руб ВАЛ]
		, 0 AS [Депозиты, руб ВАЛ]
		, 0 AS [Депозит, шт ВАЛ]
		, 0 AS [Первый депозит, руб ВАЛ]
		, 0 AS [Первый депозит, шт ВАЛ]
		, 0 AS [Общий оборот за период, ВАЛ]
		, 0 AS [Пользователи ВАЛ]
	FROM [crm].[UserRegistrations] REG 
	INNER JOIN [crm].[Profits] PRO ON PRO.UserId=REG.UserId
	GROUP BY CAST(PRO.[DateTime] AS DATE), [AtomId], [Version]


	UNION ALL

	-- [Депозиты, руб ВАЛ]
	SELECT 
		CAST(PRO.[DateTime] AS DATE) AS [Дата]
		, [AtomId] 
		, [Version]
		, 0 AS [Доход, руб]
		, 0 AS [Депозиты, руб]
		, 0 AS [Депозит, шт]
		, 0 AS [Первый депозит, руб]
		, 0 AS [Первый депозит, шт]
		, 0 AS [Общий оборот за период]
		, 0 AS [Пользователи]
		, 0 AS [Доход, руб ВАЛ]
		, SUM(Amount) AS [Депозиты, руб ВАЛ]
		, 0 AS [Депозит, шт ВАЛ]
		, 0 AS [Первый депозит, руб ВАЛ]
		, 0 AS [Первый депозит, шт ВАЛ]
		, 0 AS [Общий оборот за период, ВАЛ]
		, 0 AS [Пользователи ВАЛ]
	FROM [crm].[UserRegistrations] REG 
	INNER JOIN [crm].[Payments] PRO ON PRO.UserId=REG.UserId
	WHERE PRO.Direction=0 AND PRO.Bonus=0
	GROUP BY CAST(PRO.[DateTime] AS DATE), [AtomId], [Version]

	UNION ALL

	-- [Депозит, шт ВАЛ]
	SELECT 
		CAST(PRO.[DateTime] AS DATE) AS [Дата]
		, [AtomId] 
		, [Version]
		, 0 AS [Доход, руб]
		, 0 AS [Депозиты, руб]
		, 0 AS [Депозит, шт]
		, 0 AS [Первый депозит, руб]
		, 0 AS [Первый депозит, шт]
		, 0 AS [Общий оборот за период]
		, 0 AS [Пользователи]
		, 0 AS [Доход, руб ВАЛ]
		, 0 AS [Депозиты, руб ВАЛ]
		, COUNT(*) AS [Депозит, шт ВАЛ]
		, 0 AS [Первый депозит, руб ВАЛ]
		, 0 AS [Первый депозит, шт ВАЛ]
		, 0 AS [Общий оборот за период, ВАЛ]
		, 0 AS [Пользователи ВАЛ]
	FROM [crm].[UserRegistrations] REG 
	INNER JOIN [crm].[Payments] PRO ON PRO.UserId=REG.UserId
	WHERE PRO.Direction=0 AND PRO.Bonus=0
	GROUP BY CAST(PRO.[DateTime] AS DATE), [AtomId], [Version]


	UNION ALL

	-- [Первый депозит, руб ВАЛ]
	SELECT 
		CAST(PRO.[DateTime] AS DATE) AS [Дата]
		, [AtomId] 
		, [Version]
		, 0 AS [Доход, руб]
		, 0 AS [Депозиты, руб]
		, 0 AS [Депозит, шт]
		, 0 AS [Первый депозит, руб]
		, 0 AS [Первый депозит, шт]
		, 0 AS [Общий оборот за период]
		, 0 AS [Пользователи]
		, 0 AS [Доход, руб ВАЛ]
		, 0 AS [Депозиты, руб ВАЛ]
		, 0 AS [Депозит, шт ВАЛ]
		, SUM(Amount) AS [Первый депозит, руб ВАЛ]
		, 0 AS [Первый депозит, шт ВАЛ]
		, 0 AS [Общий оборот за период, ВАЛ]
		, 0 AS [Пользователи ВАЛ]
	FROM [crm].[UserRegistrations] REG 
	INNER JOIN [crm].[Payments] PRO ON PRO.UserId=REG.UserId
	INNER JOIN (
		-- Только первые записи пользователя в [Payments]
		SELECT ID FROM (
			SELECT Id, [UserId], [DateTime], ROW_NUMBER() OVER (PARTITION BY [UserId] ORDER BY DateTime) AS [RowNumber]
			FROM [crm].[Payments]
		) FD
		WHERE [RowNumber]=1		
	) FR ON FR.ID=PRO.ID
	WHERE PRO.Direction=0 AND PRO.Bonus=0
	GROUP BY CAST(PRO.[DateTime] AS DATE), [AtomId], [Version]

	UNION ALL

	-- [Первый депозит, шт ВАЛ]
	SELECT 
		CAST(PRO.[DateTime] AS DATE) AS [Дата]
		, [AtomId] 
		, [Version]
		, 0 AS [Доход, руб]
		, 0 AS [Депозиты, руб]
		, 0 AS [Депозит, шт]
		, 0 AS [Первый депозит, руб]
		, 0 AS [Первый депозит, шт]
		, 0 AS [Общий оборот за период]
		, 0 AS [Пользователи]
		, 0 AS [Доход, руб ВАЛ]
		, 0 AS [Депозиты, руб ВАЛ]
		, 0 AS [Депозит, шт ВАЛ]
		, 0 AS [Первый депозит, руб ВАЛ]
		, COUNT(*) AS [Первый депозит, шт ВАЛ]
		, 0 AS [Общий оборот за период, ВАЛ]
		, 0 AS [Пользователи ВАЛ]
	FROM [crm].[UserRegistrations] REG 
	INNER JOIN [crm].[Payments] PRO ON PRO.UserId=REG.UserId
	INNER JOIN (
		-- Только первые записи пользователя в [Payments]
		SELECT ID FROM (
			SELECT Id, [UserId], [DateTime], ROW_NUMBER() OVER (PARTITION BY [UserId] ORDER BY DateTime) AS [RowNumber]
			FROM [crm].[Payments]
		) FD
		WHERE [RowNumber]=1		
	) FR ON FR.ID=PRO.ID
	WHERE PRO.Direction=0 AND PRO.Bonus=0
	GROUP BY CAST(PRO.[DateTime] AS DATE), [AtomId], [Version]

	UNION ALL

	-- [Общий оборот за период, ВАЛ]
	SELECT 
		CAST(PRO.[DateTime] AS DATE) AS [Дата]
		, [AtomId] 
		, [Version]
		, 0 AS [Доход, руб]
		, 0 AS [Депозиты, руб]
		, 0 AS [Депозит, шт]
		, 0 AS [Первый депозит, руб]
		, 0 AS [Первый депозит, шт]
		, 0 AS [Общий оборот за период]
		, 0 AS [Пользователи]
		, 0 AS [Доход, руб ВАЛ]
		, 0 AS [Депозиты, руб ВАЛ]
		, 0 AS [Депозит, шт ВАЛ]
		, 0 AS [Первый депозит, руб ВАЛ]
		, 0 AS [Первый депозит, шт ВАЛ]
		, SUM(Amount) AS [Общий оборот за период, ВАЛ]
		, 0 AS [Пользователи ВАЛ]
	FROM [crm].[UserRegistrations] REG 
	INNER JOIN [crm].[FixedBets] PRO ON PRO.UserId=REG.UserId
	GROUP BY CAST(PRO.[DateTime] AS DATE), [AtomId], [Version]

	UNION ALL

	-- [Пользователи ВАЛ]
	SELECT 
		CAST(PRO.[DateTime] AS DATE) AS [Дата]
		, [AtomId] 
		, [Version]
		, 0 AS [Доход, руб]
		, 0 AS [Депозиты, руб]
		, 0 AS [Депозит, шт]
		, 0 AS [Первый депозит, руб]
		, 0 AS [Первый депозит, шт]
		, 0 AS [Общий оборот за период]
		, 0 AS [Пользователи]
		, 0 AS [Доход, руб ВАЛ]
		, 0 AS [Депозиты, руб ВАЛ]
		, 0 AS [Депозит, шт ВАЛ]
		, 0 AS [Первый депозит, руб ВАЛ]
		, 0 AS [Первый депозит, шт ВАЛ]
		, 0 AS [Общий оборот за период, ВАЛ]
		, COUNT(*) AS [Пользователи ВАЛ]
	FROM [crm].[UserRegistrations] REG 
	INNER JOIN (
		SELECT DISTINCT UserId, [DateTime] FROM [crm].[FixedBets]
	) PRO ON PRO.UserId=REG.UserId
	GROUP BY CAST(PRO.[DateTime] AS DATE), [AtomId], [Version]
) AS JB
GROUP BY [Дата], [AtomId], [Version]
GO


