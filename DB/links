
select AtomId, [Version], MONTH(CreatedOn) 
from [crm].[OpportunitiesDataRaw]
where [StatusValue] <> N'Не состоялся' 
	AND [StatusValue] <> N'Подписание' 
	AND [LgrArticleTypeCodeAliasValue]<>N'Машиноместо' 
	AND [EstimatedValue]>'100000'

group by AtomId, [Version], MONTH(CreatedOn) 


-- Нумерует записи с одинаковым email сортируя по birthday в порядке возрастания
SELECT FIO, Birthday, Email,
row_number() OVER (PARTITION BY email ORDER BY birthday DESC)  AS rating_in_section
from [EISG].[dbo].[Anketa]


-- Выберет в качестве значения first_date старший в группе birthday
SELECT FIO, Birthday, Email,
FIRST_VALUE(birthday) OVER (PARTITION BY email ORDER BY birthday DESC)  AS first_date
from [EISG].[dbo].[Anketa]

Поля вьюхи

атом

версия

дата сделки

OpportunitiesDataRaw → поле Createdon.

дата показа

AppointmentsDataRaw → поле Createdon. 

В сделке есть номера телефонов (MobilePhone, Telephone1, Telephone2). 
По ним ищем встречу в таблице AppointmentsDataRaw в поле PhoneNumber, формат телефонов одинаковый. 
Если встреч несколько берём дату в Createdon самой первой встречи.

дата первого обращения

OpportunitiesDataRaw → поле SourceDate.

Кол-во сделок

Кол-во строк в таблице OpportunitiesDataRaw
