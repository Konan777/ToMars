http://www.lagom.nl/lcd-test/inversion.php

https://developers.facebook.com/docs/marketing-api/reference/ad-creative/
https://developers.facebook.com/docs/marketing-api/insights-api

импорт данных из GA, при котором будут получены данные с Custom3, без ClientId

Параметры которые нужно получить:

DateTime
Custom3
Source
Medium
Campaign
Content
LandingPage
Показатель — количество сессий

Данные записывать в отдельную таблицу и привязывать к атомам.

В [client].[MapAtomsUserRegistrations] искать данные в новой таблице, там где привязка идет по Custom3 (UserId)



CREATE TABLE [client].[CrmResumeDaxtra](
	[Id] [bigint] NOT NULL,
	[AtomId] [int] NULL,
	[Version] [int] NULL,
	[BindingRuleId] [int] NULL,
	[BirthdateDate] [date] NULL,
	[TelMob] [nvarchar](50) NULL,
	[TelAlt] [nvarchar](50) NULL,
	[WantFunction] [nvarchar](max) NULL,
	[CompanyId] [bigint] NULL,
	[CompanyName] [nvarchar](max) NULL,
	[IbsApplicantSourceId] [bigint] NULL,
	[IbsApplicantSourceName] [nvarchar](max) NULL,
	[Description] [nvarchar](max) NULL,
	[ExternalId] [nvarchar](max) NULL,
	[PartnerId] [bigint] NULL,
	[CreateDate] [datetime] NOT NULL,
	[CreateUid] [bigint] NULL,
	[CreateName] [nvarchar](max) NULL,
	[IbsApplicantFromId] [bigint] NULL,
	[IbsApplicantFromName] [nvarchar](max) NULL,
 CONSTRAINT [PK_CrmResumeDaxtra] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

/****** Object:  Table [client].[CrmPartners]    Script Date: 12.09.2019 19:57:29 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [client].[CrmPartners](
	[Id] [bigint] NOT NULL,
	[Active] [bit] NOT NULL,
	[Applicant] [bit] NOT NULL,
	[Gender] [nvarchar](100) NULL,
	[NationalityId] [bigint] NULL,
	[NationalityName] [nvarchar](max) NULL,
	[OptOut] [bit] NOT NULL,
	[PreviousStageId] [bigint] NULL,
	[PreviousStageName] [nvarchar](max) NULL,
	[StateId] [bigint] NULL,
	[StateName] [nvarchar](max) NULL,
	[WantFunction] [nvarchar](max) NULL,
	[CreateDate] [datetime] NOT NULL,
	[CreateUid] [bigint] NULL,
	[CreateName] [nvarchar](max) NULL,
	[WriteDate] [datetime] NOT NULL,
	[WriteUid] [bigint] NULL,
	[WriteName] [nvarchar](max) NULL,
	[LeftPartner] [bit] NULL,
	[Mobile] [nvarchar](200) NULL,
	[AtomId] [int] NULL,
	[Version] [int] NULL,
	[BindingRuleId] [int] NULL
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

/****** Object:  Table [client].[CrmLog]    Script Date: 12.09.2019 19:57:30 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [client].[CrmLog](
	[Id] [bigint] NOT NULL,
	[CreateDate] [datetime] NOT NULL,
	[CreateUid] [bigint] NULL,
	[Comment] [nvarchar](max) NULL,
	[ActivityId] [bigint] NULL,
	[WriteUid] [bigint] NULL,
	[ApplicantId] [bigint] NULL,
	[DateNext] [datetime] NULL,
	[UserId] [bigint] NULL,
	[JobId] [bigint] NULL,
	[LastUpdate] [datetime] NULL,
	[CompanyId] [bigint] NULL,
	[InterviewDate] [datetime] NULL,
	[InterviewStopDate] [datetime] NULL,
	[State] [nvarchar](max) NULL,
	[DepartmentId] [bigint] NULL,
	[NextStageId] [bigint] NULL,
	[StartDatetime] [datetime] NULL,
	[WriteDate] [datetime] NULL,
	[Date] [datetime] NULL,
	[DisplayName] [nvarchar](max) NULL,
	[DateAction] [datetime] NULL,
	[FunctionId] [bigint] NULL,
	[Expired] [bit] NOT NULL,
	[FunnelId] [bigint] NULL,
	[StageId] [bigint] NULL,
	[DateLastStageChange] [datetime] NULL,
	[ResultId] [bigint] NULL,
 CONSTRAINT [PK_CrmLog] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

/****** Object:  Table [client].[CrmJobs]    Script Date: 12.09.2019 19:57:31 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [client].[CrmJobs](
	[Id] [bigint] NOT NULL,
	[Name] [nvarchar](max) NULL,
	[Active] [bit] NOT NULL,
	[DepartmentId] [bigint] NULL,
	[DepartmentName] [nvarchar](max) NULL,
	[FunctionId] [bigint] NULL,
	[FunctionName] [nvarchar](max) NULL,
	[CompanyId] [bigint] NULL,
	[CompanyName] [nvarchar](max) NULL,
	[JobPriority] [int] NULL,
	[State] [nvarchar](max) NULL,
	[NoOfRecruitment] [int] NULL,
	[ApplicationCount] [int] NULL,
	[LostDeadline] [int] NULL,
	[Description] [nvarchar](max) NULL,
	[Expirience] [nvarchar](max) NULL,
	[Requirements] [nvarchar](max) NULL,
	[Gender] [nvarchar](100) NULL,
	[AgeMax] [int] NULL,
	[AgeMin] [int] NULL,
	[Rigths] [nvarchar](max) NULL,
	[SalaryMax] [int] NULL,
	[SalaryMin] [int] NULL,
	[CreateDate] [datetime] NOT NULL,
	[CreateUid] [bigint] NULL,
	[CreateName] [nvarchar](max) NULL,
	[WriteDate] [datetime] NOT NULL,
	[WriteUid] [bigint] NULL,
	[WriteName] [nvarchar](max) NULL,
 CONSTRAINT [PK_CrmJob] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

/****** Object:  Table [client].[CrmFunctions]    Script Date: 12.09.2019 19:57:33 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [client].[CrmFunctions](
	[Id] [bigint] NOT NULL,
	[Name] [nvarchar](max) NULL,
	[Active] [bit] NOT NULL,
	[AgeMax] [int] NULL,
	[AgeMin] [int] NULL,
	[CategId] [bigint] NULL,
	[CategName] [nvarchar](max) NULL,
	[FunnelId] [bigint] NULL,
	[FunnelName] [nvarchar](max) NULL,
	[CompanyId] [bigint] NULL,
	[CompanyName] [nvarchar](max) NULL,
	[Gender] [nvarchar](100) NULL,
	[SalaryMax] [int] NULL,
	[SalaryMin] [int] NULL,
	[TimetableId] [bigint] NULL,
	[TimetableName] [nvarchar](max) NULL,
	[CreateDate] [datetime] NOT NULL,
	[CreateUid] [bigint] NULL,
	[CreateName] [nvarchar](max) NULL,
	[WriteDate] [datetime] NOT NULL,
	[WriteUid] [bigint] NULL,
	[WriteName] [nvarchar](max) NULL,
 CONSTRAINT [PK_CrmFunctions] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

/****** Object:  Table [client].[CrmDepartments]    Script Date: 12.09.2019 19:57:35 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [client].[CrmDepartments](
	[Id] [bigint] NOT NULL,
	[Name] [nvarchar](max) NULL,
	[FullName] [nvarchar](max) NULL,
	[Active] [bit] NOT NULL,
	[CategId] [bigint] NULL,
	[CategName] [nvarchar](max) NULL,
	[DepTypeId] [bigint] NULL,
	[DepTypeName] [nvarchar](max) NULL,
	[CompanyId] [bigint] NULL,
	[CompanyName] [nvarchar](max) NULL,
	[RegOfficeId] [bigint] NULL,
	[RegOfficeName] [nvarchar](max) NULL,
	[AddressDadata] [nvarchar](max) NULL,
	[CountJob] [int] NULL,
	[CreateDate] [datetime] NOT NULL,
	[CreateUid] [bigint] NULL,
	[CreateName] [nvarchar](max) NULL,
	[WriteDate] [datetime] NOT NULL,
	[WriteUid] [bigint] NULL,
	[WriteName] [nvarchar](max) NULL,
 CONSTRAINT [PK_CrmDepartments] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

/****** Object:  Table [client].[CrmApplicants]    Script Date: 12.09.2019 19:57:37 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO

CREATE TABLE [client].[CrmApplicants](
	[Id] [bigint] NOT NULL,
	[AtomId] [int] NULL,
	[Version] [int] NULL,
	[BindingRuleId] [int] NULL,
	[CompanyId] [bigint] NULL,
	[CompanyName] [nvarchar](max) NULL,
	[JobId] [bigint] NULL,
	[JobName] [nvarchar](max) NULL,
	[PartnerId] [bigint] NULL,
	[PartnerName] [nvarchar](max) NULL,
	[StageId] [bigint] NULL,
	[StageName] [nvarchar](max) NULL,
	[FunnelId] [bigint] NULL,
	[FunnelName] [nvarchar](max) NULL,
	[ActivityId] [bigint] NULL,
	[ActivityName] [nvarchar](max) NULL,
	[ResultId] [bigint] NULL,
	[ResultName] [nvarchar](max) NULL,
	[JobPriority] [int] NULL,
	[JobTimetableId] [bigint] NULL,
	[JobTimetableName] [nvarchar](max) NULL,
	[JobClosed] [bit] NOT NULL,
	[DepartmentId] [bigint] NULL,
	[DepartmentName] [nvarchar](max) NULL,
	[FunctionId] [bigint] NULL,
	[FunctionName] [nvarchar](max) NULL,
	[ActivityStartDatetime] [datetime] NULL,
	[DateAction] [datetime] NULL,
	[DateLastStageUpdate] [datetime] NULL,
	[ExecutiveId] [bigint] NULL,
	[ExecutiveName] [nvarchar](max) NULL,
	[ExecutiveRefuse] [nvarchar](max) NULL,
	[InterviewId] [bigint] NULL,
	[InterviewName] [nvarchar](max) NULL,
	[InterviewRemoveId] [bigint] NULL,
	[InterviewRemoveName] [nvarchar](max) NULL,
	[LastActivity] [datetime] NULL,
	[LastActivityId] [bigint] NULL,
	[LastActivityName] [nvarchar](max) NULL,
	[LastChangeDate] [datetime] NULL,
	[LastResultStageId] [bigint] NULL,
	[LastResultStageName] [nvarchar](max) NULL,
	[LastStageChange] [datetime] NULL,
	[LastStageId] [bigint] NULL,
	[LastStageName] [nvarchar](max) NULL,
	[OutflowReason] [nvarchar](max) NULL,
	[Reactivity] [int] NULL,
	[RefuseReason] [nvarchar](max) NULL,
	[ApplicantRefuse] [nvarchar](max) NULL,
	[SbPassed] [bit] NOT NULL,
	[SourceId] [bigint] NULL,
	[SourceName] [nvarchar](max) NULL,
	[StateDeadline] [nvarchar](max) NULL,
	[CreateDate] [datetime] NULL,
	[CreateUid] [bigint] NULL,
	[CreateName] [nvarchar](max) NULL,
	[WriteDate] [datetime] NULL,
	[WriteUid] [bigint] NULL,
	[WriteName] [nvarchar](max) NULL,
 CONSTRAINT [PK_CrmApplicants] PRIMARY KEY CLUSTERED 
(
	[Id] ASC
)WITH (STATISTICS_NORECOMPUTE = OFF, IGNORE_DUP_KEY = OFF) ON [PRIMARY]
) ON [PRIMARY] TEXTIMAGE_ON [PRIMARY]
GO

ALTER TABLE [client].[CrmPartners] ADD  DEFAULT ((1)) FOR [Active]
GO

ALTER TABLE [client].[CrmPartners] ADD  DEFAULT ((1)) FOR [Applicant]
GO

ALTER TABLE [client].[CrmPartners] ADD  DEFAULT ((1)) FOR [OptOut]
GO

ALTER TABLE [client].[CrmLog] ADD  DEFAULT ((1)) FOR [Expired]
GO

ALTER TABLE [client].[CrmJobs] ADD  DEFAULT ((1)) FOR [Active]
GO

ALTER TABLE [client].[CrmFunctions] ADD  DEFAULT ((1)) FOR [Active]
GO

ALTER TABLE [client].[CrmDepartments] ADD  DEFAULT ((1)) FOR [Active]
GO

ALTER TABLE [client].[CrmApplicants] ADD  DEFAULT ((1)) FOR [JobClosed]
GO

ALTER TABLE [client].[CrmApplicants] ADD  DEFAULT ((1)) FOR [SbPassed]
GO

ALTER TABLE [client].[CrmResumeDaxtra]  WITH CHECK ADD  CONSTRAINT [FK_CrmResumeDaxtra_Atoms] FOREIGN KEY([AtomId], [Version])
REFERENCES [core].[Atoms] ([Id], [Version])
GO

ALTER TABLE [client].[CrmResumeDaxtra] CHECK CONSTRAINT [FK_CrmResumeDaxtra_Atoms]
GO

ALTER TABLE [client].[CrmApplicants]  WITH CHECK ADD  CONSTRAINT [FK_CrmApplicants_Atoms] FOREIGN KEY([AtomId], [Version])
REFERENCES [core].[Atoms] ([Id], [Version])
GO

ALTER TABLE [client].[CrmApplicants] CHECK CONSTRAINT [FK_CrmApplicants_Atoms]
GO


