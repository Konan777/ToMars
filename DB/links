
select AtomId, [Version], MONTH(CreatedOn) 
from [crm].[OpportunitiesDataRaw]
where [StatusValue] <> N'Не состоялся' 
	AND [StatusValue] <> N'Подписание' 
	AND [LgrArticleTypeCodeAliasValue]<>N'Машиноместо' 
	AND [EstimatedValue]>'100000'

group by AtomId, [Version], MONTH(CreatedOn) 


-- Нумерует записи с одинаковым email сортируя по birthday в порядке возрастания
SELECT FIO, Birthday, Email,
row_number() OVER (PARTITION BY email ORDER BY birthday DESC)  AS rating_in_section
from [EISG].[dbo].[Anketa]


-- Выберет в качестве значения first_date старший в группе birthday
SELECT FIO, Birthday, Email,
FIRST_VALUE(birthday) OVER (PARTITION BY email ORDER BY birthday DESC)  AS first_date
from [EISG].[dbo].[Anketa]

SELECT [Атом], [Версия], [Дата сделки], [Дата показа], [Дата первого обращения], COUNT(*) AS [Кол-во сделок]
FROM (
	SELECT 
		OPP.[AtomId] AS [Атом]
		, OPP.[Version] AS [Версия]
		, MONTH(OPP.[CreatedOn]) AS [Дата сделки]
		, FIRST_VALUE(APP.[CreatedOn]) OVER (PARTITION BY OPP.[CreatedOn] ORDER BY APP.[CreatedOn] ASC)  AS [Дата показа]
		, CAST(OPP.[SourceDate] as DATE) AS [Дата первого обращения]
	FROM [crm].[OpportunitiesDataRaw] OPP
	INNER JOIN [crm].[AppointmentsDataRaw] APP 
		ON (APP.PhoneNumber=OPP.MobilePhone OR APP.PhoneNumber=OPP.Telephone1 OR APP.PhoneNumber=OPP.Telephone2)
	WHERE OPP.[StatusValue] <> N'Не состоялся' 
		AND OPP.[StatusValue] <> N'Подписание' 
		AND OPP.[LgrArticleTypeCodeAliasValue]<>N'Машиноместо' 
		AND OPP.[EstimatedValue]>'100000'
) AS UNI
GROUP BY [Атом], [Версия], [Дата сделки], [Дата показа], [Дата первого обращения]
