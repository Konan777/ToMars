	-- Соберем поля первичного ключа не являющегося identity
	SELECT @primaryKey = COALESCE(@primaryKey + ', ', '') + c.name,
		@joinByPrimaryKeyCondition = COALESCE(@joinByPrimaryKeyCondition + ' AND ', '') + 'T.['+c.name+'] = ['+@tableSchema+'].['+@tableName+'].['+c.name+']',
		@condPKIsNotNull = COALESCE(@condPKIsNotNull + ' AND ', '') + '['+@tableSchema+'].['+@tableName+'].['+c.name+'] IS NOT NULL',
		@condPKIsNull = COALESCE(@condPKIsNull + ' AND ', '') + '['+@tableSchema+'].['+@tableName+'].['+c.name+'] is null'
	FROM 
		sys.tables t 
		INNER JOIN sys.schemas sch on sch.schema_id= t.schema_id
		LEFT JOIN sys.columns c ON c.OBJECT_ID = t.OBJECT_ID
		LEFT JOIN sys.identity_columns idc ON idc.OBJECT_ID = t.OBJECT_ID AND idc.column_id = c.column_id AND idc.is_identity = 1
		LEFT JOIN sys.index_columns ic ON ic.OBJECT_ID = t.OBJECT_ID AND ic.column_id = c.column_id
		LEFT JOIN sys.indexes i ON i.OBJECT_ID = t.OBJECT_ID AND i.index_id = ic.index_id AND i.is_primary_key = 1
	WHERE t.type = 'U' AND (idc.is_identity = 1 OR i.is_primary_key = 1 OR c.name = 'ID') 
		and idc.is_identity is null and i.is_primary_key IS NOT NULL and t.name=@tableName
		and sch.name=@tableSchema

	-- Соберем поле первичного ключа _являющегося_ identity
	SELECT @identityKey=c.name,
		@joinByPrimaryKeyCondition = COALESCE(@joinByPrimaryKeyCondition + ' AND ', '') + 'T.['+c.name+'] = ['+@tableSchema+'].['+@tableName+'].['+c.name+']',
		@condPKIsNotNull = COALESCE(@condPKIsNotNull + ' AND ', '') + '['+@tableSchema+'].['+@tableName+'].['+c.name+'] IS NOT NULL',
		@condPKIsNull = COALESCE(@condPKIsNull + ' AND ', '') + '['+@tableSchema+'].['+@tableName+'].['+c.name+'] is null'
	FROM 
		sys.tables t 
		INNER JOIN sys.schemas sch on sch.schema_id= t.schema_id
		LEFT JOIN sys.columns c ON c.OBJECT_ID = t.OBJECT_ID
		LEFT JOIN sys.identity_columns idc ON idc.OBJECT_ID = t.OBJECT_ID AND idc.column_id = c.column_id AND idc.is_identity = 1
		LEFT JOIN sys.index_columns ic ON ic.OBJECT_ID = t.OBJECT_ID AND ic.column_id = c.column_id
		LEFT JOIN sys.indexes i ON i.OBJECT_ID = t.OBJECT_ID AND i.index_id = ic.index_id AND i.is_primary_key = 1
	WHERE t.type = 'U' AND (idc.is_identity = 1 OR i.is_primary_key = 1 OR c.name = 'ID') 
		and idc.is_identity=1 and i.is_primary_key IS NOT NULL and t.name=@tableName
		and sch.name=@tableSchema
