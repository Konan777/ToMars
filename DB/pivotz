-- Как мапим атомы в таблицах [CupisState], [Payments], [Profits], [SettledBets??]

Реактивация:

-- Как считаем усннувших игроков
-- В данный момент у нас мапится только [FixedBets]. Выборка только по ней?

CREATE VIEW [pivotparts].[Reactivation]
AS
	SELECT SB.[DateTime], SB.[AtomId], SB.[Version], 0 AS [Уснувшие игроки], COUNT(*) AS [Реактивированные игроки]
	FROM [crm].[FixedBets] SB
	WHERE SB.Days>120
	GROUP BY SB.[DateTime], SB.[AtomId], SB.[Version]
	
	UNION ALL

	SELECT SB.[DateTime], SB.[AtomId], SB.[Version], COUNT(*) AS [Уснувшие игроки], 0 AS [Реактивированные игроки]
	FROM [crm].[FixedBets] SB
	WHERE CAST(SB.[DateTime] AS DATE)<CAST(GETDATE()+120 AS DATE)
	GROUP BY SB.[DateTime], SB.[AtomId], SB.[Version]

	-- TODO: Добавить остальные таблицы ([SettledBets]...[])
GO

ALTER TABLE [crm].[SettledBets]
ADD
	[AtomId] [int] NULL,
	[Version] [int] NULL,
	[BindingRuleId] [nvarchar](300) NULL,
	[Days] [int] NULL,
	[ReactivatedDays] [int] NULL


Качество:

-- Подтвержденные регистрации. Количество пользователей у которых пройдена идентификация в ППС?
-- 3 последние колонки, что с ними?

CREATE VIEW [pivotparts].[Quality]
AS
	SELECT 
		[DateTime]
		, [AtomId]
		, [Version]
		, SUM([Регистрации]) AS [Регистрации]
		, SUM([Подтвержденные регистрации]) AS [Подтвержденные регистрации]
		, SUM([Качественных регистраций]) AS [Качественных регистраций]
		, SUM([Активные игроки]) AS [Активные игроки]
		, SUM([Красные]) AS [Красные]
		, SUM([Желтые]) AS [Желтые]
		, SUM([Серые]) AS [Серые]
	FROM (
		SELECT 
			[DateTime]
			, [AtomId]
			, [Version]
			, COUNT(*) AS [Регистрации]
			, 0 AS [Подтвержденные регистрации]
			, 0 AS [Качественных регистраций]
			, 0 AS [Активные игроки]
			, 0 AS [Красные]
			, 0 AS [Желтые]
			, 0 AS [Серые]
		FROM [crm].[Registrations]
		GROUP BY [DateTime], [AtomId], [Version]
	
		UNION ALL
	
		SELECT 
			[DateTime]
			, [AtomId]
			, [Version]
			, 0 AS [Регистрации]
			, COUNT(*) AS [Подтвержденные регистрации]
			, 0 AS [Качественных регистраций]
			, 0 AS [Активные игроки]
			, 0 AS [Красные]
			, 0 AS [Желтые]
			, 0 AS [Серые]
		FROM [crm].[CupisState] 
		WHERE [CupisState] = 2
		GROUP BY [DateTime], [AtomId], [Version]

		UNION ALL

		SELECT 
			[DateTime]
			, [AtomId]
			, [Version]
			, 0 AS [Регистрации]
			, 0 AS [Подтвержденные регистрации]
			, COUNT(*) AS [Качественных регистраций]
			, 0 AS [Активные игроки]
			, 0 AS [Красные]
			, 0 AS [Желтые]
			, 0 AS [Серые]
		FROM [crm].[Payments] 
		GROUP BY [DateTime], [AtomId], [Version]
	
		UNION ALL

		SELECT 
			[DateTime]
			, [AtomId]
			, [Version]
			, 0 AS [Регистрации]
			, 0 AS [Подтвержденные регистрации]
			, 0 AS [Качественных регистраций]
			, COUNT(*) AS [Активные игроки]
			, 0 AS [Красные]
			, 0 AS [Желтые]
			, 0 AS [Серые]
		FROM [crm].[FixedBets] 
		WHERE CAST([DateTime] AS DATE)>=CAST(GETDATE()-30 AS DATE)
		GROUP BY [DateTime], [AtomId], [Version]

		UNION ALL

		SELECT 
			[DateTime]
			, [AtomId]
			, [Version]
			, 0 AS [Регистрации]
			, 0 AS [Подтвержденные регистрации]
			, 0 AS [Качественных регистраций]
			, 0 AS [Активные игроки]
			, COUNT(*) AS [Красные]
			, 0 AS [Желтые]
			, 0 AS [Серые]
		FROM [crm].[Users] US
		INNER JOIN [crm].[CupisState] CS ON CS.[UserId]=US.[UserId]
		WHERE [CupisState] = 2
		GROUP BY [DateTime], [AtomId], [Version]

		UNION ALL

		SELECT 
			[DateTime]
			, [AtomId]
			, [Version]
			, 0 AS [Регистрации]
			, 0 AS [Подтвержденные регистрации]
			, 0 AS [Качественных регистраций]
			, 0 AS [Активные игроки]
			, 0 AS [Красные]
			, COUNT(*) AS [Желтые]
			, 0 AS [Серые]
		FROM [crm].[Users] US
		INNER JOIN [crm].[CupisState] CS ON CS.[UserId]=US.[UserId]
		WHERE [CupisState] = 1
		GROUP BY [DateTime], [AtomId], [Version]

		UNION ALL

		SELECT 
			[DateTime]
			, [AtomId]
			, [Version]
			, 0 AS [Регистрации]
			, 0 AS [Подтвержденные регистрации]
			, 0 AS [Качественных регистраций]
			, 0 AS [Активные игроки]
			, 0 AS [Красные]
			, 0 AS [Желтые]
			, COUNT(*) AS [Серые]
		FROM [crm].[Users] US
		INNER JOIN [crm].[CupisState] CS ON CS.[UserId]=US.[UserId]
		WHERE [CupisState] = 0
		GROUP BY [DateTime], [AtomId], [Version]

	) AS GR
	GROUP BY [DateTime], [AtomId], [Version]



Доход:
-- Последние 9 колонок. Что с ними?

	

	
	

	
	

	
	

	