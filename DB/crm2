/****** Object:  View [pivotparts].[Crm3]    Script Date: 10.07.2019 22:10:16 ******/
SET ANSI_NULLS ON
GO

SET QUOTED_IDENTIFIER ON
GO



CREATE VIEW [pivotparts].[Crm3]
AS

--Первые кандидаты для конкретного соискателя
WITH FirstApplicants
AS
(
	SELECT	* 
	FROM	(
			SELECT	*, ROW_NUMBER() OVER (PARTITION BY [PartnerId] ORDER BY [CreateDate]) AS [RowNum] 
			FROM	[client].[CrmApplicants]
			) AS A
	WHERE [RowNum] = 1
)

SELECT
	CAST([Дата] AS DATETIME) AS [Дата],
	[AtomId],
	[Version],
	SUM(t1.[Розница: Соискатели накопительные]) AS [Розница: Соискатели накопительные],
	SUM(t1.[Розница: Соискатели валовые]) AS [Розница: Соискатели валовые],
	SUM(t1.[Розница: Кандидаты накопительные]) AS [Розница: Кандидаты накопительные],
	SUM(t1.[Розница: Кандидаты валовые]) AS [Розница: Кандидаты валовые],
	SUM(t1.[ДМЗДМ: Соискатели накопительные]) AS [ДМЗДМ: Соискатели накопительные],
	SUM(t1.[ДМЗДМ: Соискатели валовые]) AS [ДМЗДМ: Соискатели валовые],
	SUM(t1.[ДМЗДМ: Кандидаты накопительные]) AS [ДМЗДМ: Кандидаты накопительные],
	SUM(t1.[ДМЗДМ: Кандидаты валовые]) AS [ДМЗДМ: Кандидаты валовые],
	-- Итоги трудоустройства Накопительные 
	SUM(t1.[Розница: Принят накопительные]) AS [Розница: Принят накопительные],
	SUM(t1.[Розница: Мы отказали накопительные]) AS [Розница: Мы отказали накопительные],
	SUM(t1.[Розница: Не прошел СБ накопительные]) AS [Розница: Не прошел СБ накопительные],
	SUM(t1.[Розница: Не прошел СД накопительные]) AS [Розница: Не прошел СД накопительные],
	SUM(t1.[Розница: Отказался накопительные]) AS [Розница: Отказался накопительные],
	SUM(t1.[Розница: Смена вакансии накопительные]) AS [Розница: Смена вакансии накопительные],
	SUM(t1.[Розница: Резерв накопительные]) AS [Розница: Резерв накопительные],
	SUM(t1.[ДМЗДМ: Принят накопительные]) AS [ДМЗДМ: Принят накопительные],
	SUM(t1.[ДМЗДМ: Мы отказали накопительные]) AS [ДМЗДМ: Мы отказали накопительные],
	SUM(t1.[ДМЗДМ: Не прошел СБ накопительные]) AS [ДМЗДМ: Не прошел СБ накопительные],
	SUM(t1.[ДМЗДМ: Отказался накопительные]) AS [ДМЗДМ: Отказался накопительные],
	SUM(t1.[ДМЗДМ: Смена вакансии накопительные]) AS [ДМЗДМ: Смена вакансии накопительные],
	SUM(t1.[ДМЗДМ: Резерв накопительные]) AS [ДМЗДМ: Резерв накопительные],
	-- Этапы трудоустройства
	SUM(t1.[Розница: Обработка  накопительные]) AS [Розница: Обработка  накопительные],
	SUM(t1.[Розница: Интервью с руководителем накопительные]) AS [Розница: Интервью с руководителем накопительные],
	SUM(t1.[Розница: СБ]) AS [Розница: СБ],
	SUM(t1.[Розница: Медосмотр]) AS [Розница: Медосмотр],
	SUM(t1.[Розница: Оформление]) AS [Розница: Оформление],
	SUM(t1.[ДМЗДМ: Обработка  накопительные]) AS [ДМЗДМ: Обработка  накопительные],
	SUM(t1.[ДМЗДМ: Интервью с рекрутером накопительные]) AS [ДМЗДМ: Интервью с рекрутером накопительные],
	SUM(t1.[ДМЗДМ: Домашнее задание накопительные]) AS [ДМЗДМ: Домашнее задание накопительные],
	SUM(t1.[ДМЗДМ: СБ]) AS [ДМЗДМ: СБ],
	SUM(t1.[ДМЗДМ: Интервью с ДД и РД накопительные]) AS [ДМЗДМ: Интервью с ДД и РД накопительные],
	SUM(t1.[ДМЗДМ: Медосмотр]) AS [ДМЗДМ: Медосмотр],
	SUM(t1.[ДМЗДМ: Оформление]) AS [ДМЗДМ: Оформление],
	-- Итоги трудоустройства Валовые
	SUM(t1.[Розница: Принят валовые]) AS [Розница: Принят валовые],
	SUM(t1.[Розница: Мы отказали валовые]) AS [Розница: Мы отказали валовые],
	SUM(t1.[Розница: Не прошел СБ валовые]) AS [Розница: Не прошел СБ валовые],
	SUM(t1.[Розница: Не прошел СД валовые]) AS [Розница: Не прошел СД валовые],
	SUM(t1.[Розница: Отказался валовые]) AS [Розница: Отказался валовые],
	SUM(t1.[Розница: Смена вакансии валовые]) AS [Розница: Смена вакансии валовые],
	SUM(t1.[Розница: Резерв валовые]) AS [Розница: Резерв валовые],
	SUM(t1.[ДМЗДМ: Принят валовые]) AS [ДМЗДМ: Принят валовые],
	SUM(t1.[ДМЗДМ: Мы отказали валовые]) AS [ДМЗДМ: Мы отказали валовые],
	SUM(t1.[ДМЗДМ: Не прошел СБ валовые]) AS [ДМЗДМ: Не прошел СБ валовые],
	SUM(t1.[ДМЗДМ: Отказался валовые]) AS [ДМЗДМ: Отказался валовые],
	SUM(t1.[ДМЗДМ: Смена вакансии валовые]) AS [ДМЗДМ: Смена вакансии валовые],
	SUM(t1.[ДМЗДМ: Резерв валовые]) AS [ДМЗДМ: Резерв валовые],
	SUM(t1.[Розница: Обработка валовые]) AS [Розница: Обработка валовые],
	SUM(t1.[Розница: Интервью с руководителем валовые]) AS [Розница: Интервью с руководителем валовые],
	SUM(t1.[Розница: СБ валовые]) AS [Розница: СБ валовые],
	SUM(t1.[Розница: Медосмотр валовые]) AS [Розница: Медосмотр валовые],
	SUM(t1.[Розница: Оформление валовые]) AS [Розница: Оформление валовые],
	SUM(t1.[ДМЗДМ: Обработка валовые]) AS [ДМЗДМ: Обработка валовые],
	SUM(t1.[ДМЗДМ: Интервью с рекрутером валовые]) AS [ДМЗДМ: Интервью с рекрутером валовые],
	SUM(t1.[ДМЗДМ: Домашнее задание валовые]) AS [ДМЗДМ: Домашнее задание валовые],
	SUM(t1.[ДМЗДМ: СБ валовые]) AS [ДМЗДМ: СБ валовые],
	SUM(t1.[ДМЗДМ: Интервью с ДД и РД валовые]) AS [ДМЗДМ: Интервью с ДД и РД валовые],
	SUM(t1.[ДМЗДМ: Медосмотр валовые]) AS [ДМЗДМ: Медосмотр валовые],
	SUM(t1.[ДМЗДМ: Оформление валовые]) AS [ДМЗДМ: Оформление валовые],
	-- Итоги трудоустройства Поточные 
	SUM(t1.[Розница: Принят по дате кандидата]) AS [Розница: Принят по дате кандидата],
	SUM(t1.[Розница: Мы отказали по дате кандидата]) AS [Розница: Мы отказали по дате кандидата],
	SUM(t1.[Розница: Не прошел СБ по дате кандидата]) AS [Розница: Не прошел СБ по дате кандидата],
	SUM(t1.[Розница: Не прошел СД по дате кандидата]) AS [Розница: Не прошел СД по дате кандидата],
	SUM(t1.[Розница: Отказался по дате кандидата]) AS [Розница: Отказался по дате кандидата],
	SUM(t1.[Розница: Смена вакансии по дате кандидата]) AS [Розница: Смена вакансии по дате кандидата],
	SUM(t1.[Розница: Резерв по дате кандидата]) AS [Розница: Резерв по дате кандидата],
	SUM(t1.[ДМЗДМ: Принят по дате кандидата]) AS [ДМЗДМ: Принят по дате кандидата],
	SUM(t1.[ДМЗДМ: Мы отказали по дате кандидата]) AS [ДМЗДМ: Мы отказали по дате кандидата],
	SUM(t1.[ДМЗДМ: Не прошел СБ по дате кандидата]) AS [ДМЗДМ: Не прошел СБ по дате кандидата],
	SUM(t1.[ДМЗДМ: Отказался по дате кандидата]) AS [ДМЗДМ: Отказался по дате кандидата],
	SUM(t1.[ДМЗДМ: Смена вакансии по дате кандидата]) AS [ДМЗДМ: Смена вакансии по дате кандидата],
	SUM(t1.[ДМЗДМ: Резерв по дате кандидата]) AS [ДМЗДМ: Резерв по дате кандидата],
	-- Этапы трудоустройства Поточные
	SUM(t1.[Розница: Обработка  по дате кандидата]) AS [Розница: Обработка  по дате кандидата],
	SUM(t1.[Розница: Интервью с руководителем по дате кандидата]) AS [Розница: Интервью с руководителем по дате кандидата],
	SUM(t1.[Розница: СБ по дате кандидата]) AS [Розница: СБ по дате кандидата],
	SUM(t1.[Розница: Медосмотр по дате кандидата]) AS [Розница: Медосмотр по дате кандидата],
	SUM(t1.[Розница: Оформление по дате кандидата]) AS [Розница: Оформление по дате кандидата],
	SUM(t1.[ДМЗДМ: Обработка  по дате кандидата]) AS [ДМЗДМ: Обработка  по дате кандидата],
	SUM(t1.[ДМЗДМ: Интервью с рекрутером по дате кандидата]) AS [ДМЗДМ: Интервью с рекрутером по дате кандидата],
	SUM(t1.[ДМЗДМ: Домашнее задание по дате кандидата]) AS [ДМЗДМ: Домашнее задание по дате кандидата],
	SUM(t1.[ДМЗДМ: СБ по дате кандидата]) AS [ДМЗДМ: СБ по дате кандидата],
	SUM(t1.[ДМЗДМ: Интервью с ДД и РД по дате кандидата]) AS [ДМЗДМ: Интервью с ДД и РД по дате кандидата],
	SUM(t1.[ДМЗДМ: Медосмотр по дате кандидата]) AS [ДМЗДМ: Медосмотр по дате кандидата],
	SUM(t1.[ДМЗДМ: Оформление по дате кандидата]) AS [ДМЗДМ: Оформление по дате кандидата]
FROM (
		SELECT 
			CAST(P.[CreateDate] AS DATETIME)						AS [Дата],
			COALESCE(D.[AtomId], A.[AtomId])						AS [AtomId],
			COALESCE(D.[Version], A.[Version])						AS [Version],
			SUM(CASE WHEN A.[FunnelId]=8 THEN 1 ELSE 0 END)			AS [Розница: Соискатели накопительные],
			SUM(CASE WHEN A.[FunnelId]=8 THEN 1 ELSE 0 END)			AS [Розница: Соискатели валовые],
			0														AS [Розница: Кандидаты накопительные],
			0														AS [Розница: Кандидаты валовые],
			SUM(CASE WHEN A.[FunnelId]=16 THEN 1 ELSE 0 END)		AS [ДМЗДМ: Соискатели накопительные],
			SUM(CASE WHEN A.[FunnelId]=16 THEN 1 ELSE 0 END)		AS [ДМЗДМ: Соискатели валовые],
			0														AS [ДМЗДМ: Кандидаты накопительные],
			0														AS [ДМЗДМ: Кандидаты валовые],
			-- Итоги трудоустройства Накопительные 
			0														AS [Розница: Принят накопительные],
			0														AS [Розница: Мы отказали накопительные],
			0														AS [Розница: Не прошел СБ накопительные],
			0														AS [Розница: Не прошел СД накопительные],
			0														AS [Розница: Отказался накопительные],
			0														AS [Розница: Смена вакансии накопительные],
			0														AS [Розница: Резерв накопительные],
			0														AS [ДМЗДМ: Принят накопительные],
			0														AS [ДМЗДМ: Мы отказали накопительные],
			0														AS [ДМЗДМ: Не прошел СБ накопительные],
			0														AS [ДМЗДМ: Отказался накопительные],
			0														AS [ДМЗДМ: Смена вакансии накопительные],
			0														AS [ДМЗДМ: Резерв накопительные],
			-- Этапы трудоустройства
			0														AS [Розница: Обработка  накопительные],
			0														AS [Розница: Интервью с руководителем накопительные],
			0														AS [Розница: СБ],
			0														AS [Розница: Медосмотр],
			0														AS [Розница: Оформление],
			0														AS [ДМЗДМ: Обработка  накопительные],
			0														AS [ДМЗДМ: Интервью с рекрутером накопительные],
			0														AS [ДМЗДМ: Домашнее задание накопительные],
			0														AS [ДМЗДМ: СБ],
			0														AS [ДМЗДМ: Интервью с ДД и РД накопительные],
			0														AS [ДМЗДМ: Медосмотр],
			0														AS [ДМЗДМ: Оформление],
			-- Итоги трудоустройства Валовые
			0														AS [Розница: Принят валовые],
			0														AS [Розница: Мы отказали валовые],
			0														AS [Розница: Не прошел СБ валовые],
			0														AS [Розница: Не прошел СД валовые],
			0														AS [Розница: Отказался валовые],
			0														AS [Розница: Смена вакансии валовые],
			0														AS [Розница: Резерв валовые],
			0														AS [ДМЗДМ: Принят валовые],
			0														AS [ДМЗДМ: Мы отказали валовые],
			0														AS [ДМЗДМ: Не прошел СБ валовые],
			0														AS [ДМЗДМ: Отказался валовые],
			0														AS [ДМЗДМ: Смена вакансии валовые],
			0														AS [ДМЗДМ: Резерв валовые],
			0														AS [Розница: Обработка валовые],
			0														AS [Розница: Интервью с руководителем валовые],
			0														AS [Розница: СБ валовые],
			0														AS [Розница: Медосмотр валовые],
			0														AS [Розница: Оформление валовые],
			0														AS [ДМЗДМ: Обработка валовые],
			0														AS [ДМЗДМ: Интервью с рекрутером валовые],
			0														AS [ДМЗДМ: Домашнее задание валовые],
			0														AS [ДМЗДМ: СБ валовые],
			0														AS [ДМЗДМ: Интервью с ДД и РД валовые],
			0														AS [ДМЗДМ: Медосмотр валовые],
			0														AS [ДМЗДМ: Оформление валовые],
			-- Итоги трудоустройства Поточные 
			0														AS [Розница: Принят по дате кандидата],
			0														AS [Розница: Мы отказали по дате кандидата],
			0														AS [Розница: Не прошел СБ по дате кандидата],
			0														AS [Розница: Не прошел СД по дате кандидата],
			0														AS [Розница: Отказался по дате кандидата],
			0														AS [Розница: Смена вакансии по дате кандидата],
			0														AS [Розница: Резерв по дате кандидата],
			0														AS [ДМЗДМ: Принят по дате кандидата],
			0														AS [ДМЗДМ: Мы отказали по дате кандидата],
			0														AS [ДМЗДМ: Не прошел СБ по дате кандидата],
			0														AS [ДМЗДМ: Отказался по дате кандидата],
			0														AS [ДМЗДМ: Смена вакансии по дате кандидата],
			0														AS [ДМЗДМ: Резерв по дате кандидата],
			-- Этапы трудоустройства Поточные
			0														AS [Розница: Обработка  по дате кандидата],
			0														AS [Розница: Интервью с руководителем по дате кандидата],
			0														AS [Розница: СБ по дате кандидата],
			0														AS [Розница: Медосмотр по дате кандидата],
			0														AS [Розница: Оформление по дате кандидата],
			0														AS [ДМЗДМ: Обработка  по дате кандидата],
			0														AS [ДМЗДМ: Интервью с рекрутером по дате кандидата],
			0														AS [ДМЗДМ: Домашнее задание по дате кандидата],
			0														AS [ДМЗДМ: СБ по дате кандидата],
			0														AS [ДМЗДМ: Интервью с ДД и РД по дате кандидата],
			0														AS [ДМЗДМ: Медосмотр по дате кандидата],
			0														AS [ДМЗДМ: Оформление по дате кандидата]
		FROM [client].[CrmPartners] P
		LEFT JOIN FirstApplicants A ON A.[PartnerId] = P.[Id]
		LEFT JOIN [client].[CrmResumeDaxtra] D ON D.[PartnerId] = P.[Id]
		WHERE 
			A.[PartnerId] IS NOT NULL -- отсеяли чужих соискателей
		GROUP BY P.[CreateDate], COALESCE(D.[AtomId], A.[AtomId]), COALESCE(D.[Version], A.[Version])
	
		UNION ALL

		SELECT 
			CAST(P.[CreateDate] AS DATETIME)						AS [Дата],
			COALESCE(D.[AtomId], FA.[AtomId])						AS [AtomId],
			COALESCE(D.[Version], FA.[Version])						AS [Version],
			0														AS [Розница: Соискатели накопительные],
			0														AS [Розница: Соискатели валовые],
			SUM(CASE WHEN A.[FunnelId]=8 THEN 1 ELSE 0 END)			AS [Розница: Кандидаты накопительные],
			SUM(CASE WHEN A.[FunnelId]=8 THEN 1 ELSE 0 END)			AS [Розница: Кандидаты валовые],
			0														AS [ДМЗДМ: Соискатели накопительные],
			0														AS [ДМЗДМ: Соискатели валовые],
			SUM(CASE WHEN A.[FunnelId]=16 THEN 1 ELSE 0 END)		AS [ДМЗДМ: Кандидаты накопительные],
			SUM(CASE WHEN A.[FunnelId]=16 THEN 1 ELSE 0 END)		AS [ДМЗДМ: Кандидаты валовые],
			-- Итоги трудоустройства Накопительные 
			0														AS [Розница: Принят накопительные],
			0														AS [Розница: Мы отказали накопительные],
			0														AS [Розница: Не прошел СБ накопительные],
			0														AS [Розница: Не прошел СД накопительные],
			0														AS [Розница: Отказался накопительные],
			0														AS [Розница: Смена вакансии накопительные],
			0														AS [Розница: Резерв накопительные],
			0														AS [ДМЗДМ: Принят накопительные],
			0														AS [ДМЗДМ: Мы отказали накопительные],
			0														AS [ДМЗДМ: Не прошел СБ накопительные],
			0														AS [ДМЗДМ: Отказался накопительные],
			0														AS [ДМЗДМ: Смена вакансии накопительные],
			0														AS [ДМЗДМ: Резерв накопительные],
			-- Этапы трудоустройства
			0														AS [Розница: Обработка  накопительные],
			0														AS [Розница: Интервью с руководителем накопительные],
			0														AS [Розница: СБ],
			0														AS [Розница: Медосмотр],
			0														AS [Розница: Оформление],
			0														AS [ДМЗДМ: Обработка  накопительные],
			0														AS [ДМЗДМ: Интервью с рекрутером накопительные],
			0														AS [ДМЗДМ: Домашнее задание накопительные],
			0														AS [ДМЗДМ: СБ],
			0														AS [ДМЗДМ: Интервью с ДД и РД накопительные],
			0														AS [ДМЗДМ: Медосмотр],
			0														AS [ДМЗДМ: Оформление],
			-- Итоги трудоустройства Валовые
			0														AS [Розница: Принят валовые],
			0														AS [Розница: Мы отказали валовые],
			0														AS [Розница: Не прошел СБ валовые],
			0														AS [Розница: Не прошел СД валовые],
			0														AS [Розница: Отказался валовые],
			0														AS [Розница: Смена вакансии валовые],
			0														AS [Розница: Резерв валовые],
			0														AS [ДМЗДМ: Принят валовые],
			0														AS [ДМЗДМ: Мы отказали валовые],
			0														AS [ДМЗДМ: Не прошел СБ валовые],
			0														AS [ДМЗДМ: Отказался валовые],
			0														AS [ДМЗДМ: Смена вакансии валовые],
			0														AS [ДМЗДМ: Резерв валовые],
			0														AS [Розница: Обработка валовые],
			0														AS [Розница: Интервью с руководителем валовые],
			0														AS [Розница: СБ валовые],
			0														AS [Розница: Медосмотр валовые],
			0														AS [Розница: Оформление валовые],
			0														AS [ДМЗДМ: Обработка валовые],
			0														AS [ДМЗДМ: Интервью с рекрутером валовые],
			0														AS [ДМЗДМ: Домашнее задание валовые],
			0														AS [ДМЗДМ: СБ валовые],
			0														AS [ДМЗДМ: Интервью с ДД и РД валовые],
			0														AS [ДМЗДМ: Медосмотр валовые],
			0														AS [ДМЗДМ: Оформление валовые],
			-- Итоги трудоустройства Поточные 
			0														AS [Розница: Принят по дате кандидата],
			0														AS [Розница: Мы отказали по дате кандидата],
			0														AS [Розница: Не прошел СБ по дате кандидата],
			0														AS [Розница: Не прошел СД по дате кандидата],
			0														AS [Розница: Отказался по дате кандидата],
			0														AS [Розница: Смена вакансии по дате кандидата],
			0														AS [Розница: Резерв по дате кандидата],
			0														AS [ДМЗДМ: Принят по дате кандидата],
			0														AS [ДМЗДМ: Мы отказали по дате кандидата],
			0														AS [ДМЗДМ: Не прошел СБ по дате кандидата],
			0														AS [ДМЗДМ: Отказался по дате кандидата],
			0														AS [ДМЗДМ: Смена вакансии по дате кандидата],
			0														AS [ДМЗДМ: Резерв по дате кандидата],
			-- Этапы трудоустройства Поточные
			0														AS [Розница: Обработка  по дате кандидата],
			0														AS [Розница: Интервью с руководителем по дате кандидата],
			0														AS [Розница: СБ по дате кандидата],
			0														AS [Розница: Медосмотр по дате кандидата],
			0														AS [Розница: Оформление по дате кандидата],
			0														AS [ДМЗДМ: Обработка  по дате кандидата],
			0														AS [ДМЗДМ: Интервью с рекрутером по дате кандидата],
			0														AS [ДМЗДМ: Домашнее задание по дате кандидата],
			0														AS [ДМЗДМ: СБ по дате кандидата],
			0														AS [ДМЗДМ: Интервью с ДД и РД по дате кандидата],
			0														AS [ДМЗДМ: Медосмотр по дате кандидата],
			0														AS [ДМЗДМ: Оформление по дате кандидата]
		FROM [client].[CrmApplicants] A
		LEFT JOIN [client].[CrmPartners] P ON A.[PartnerId] = P.[Id]
		LEFT JOIN FirstApplicants FA ON FA.[PartnerId] = A.[PartnerId]
		LEFT JOIN [client].[CrmResumeDaxtra] D ON D.[PartnerId] = P.[Id]
		WHERE 
			A.[PartnerId] IS NOT NULL		-- отсеяли чужих соискателей
			AND FA.[PartnerId] IS NOT NULL	-- отсеяли чужих соискателей
		GROUP BY P.[CreateDate], COALESCE(D.[AtomId], FA.[AtomId]), COALESCE(D.[Version], FA.[Version])

		UNION ALL

		SELECT 
			CAST(P.[CreateDate] AS DATETIME)						AS [Дата],
			D.[AtomId]												AS [AtomId],
			D.[Version]												AS [Version],
			0														AS [Розница: Соискатели накопительные],
			0														AS [Розница: Соискатели валовые],
			0														AS [Розница: Кандидаты накопительные],
			0														AS [Розница: Кандидаты валовые],
			0														AS [ДМЗДМ: Соискатели накопительные],
			0														AS [ДМЗДМ: Соискатели валовые],
			0														AS [ДМЗДМ: Кандидаты накопительные],
			0														AS [ДМЗДМ: Кандидаты валовые],
			-- Итоги трудоустройства Накопительные 
			0														AS [Розница: Принят накопительные],
			SUM(CASE WHEN A.[StageId]=147 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Мы отказали накопительные],
			SUM(CASE WHEN A.[StageId]=150 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Не прошел СБ накопительные],
			SUM(CASE WHEN A.[StageId]=249 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Не прошел СД накопительные],
			SUM(CASE WHEN A.[StageId]=146 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Отказался накопительные],
			SUM(CASE WHEN A.[StageId]=151 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Смена вакансии накопительные],
			SUM(CASE WHEN A.[StageId]=149 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Резерв накопительные],
			0														AS [ДМЗДМ: Принят накопительные],
			SUM(CASE WHEN A.[StageId]=233 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Мы отказали накопительные],
			SUM(CASE WHEN A.[StageId]=236 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Не прошел СБ накопительные],
			SUM(CASE WHEN A.[StageId]=231 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Отказался накопительные],
			SUM(CASE WHEN A.[StageId]=237 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Смена вакансии накопительные],
			SUM(CASE WHEN A.[StageId]=235 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Резерв накопительные],
			-- Этапы трудоустройства
			0														AS [Розница: Обработка  накопительные],
			0														AS [Розница: Интервью с руководителем накопительные],
			0														AS [Розница: СБ],
			0														AS [Розница: Медосмотр],
			0														AS [Розница: Оформление],
			0														AS [ДМЗДМ: Обработка  накопительные],
			0														AS [ДМЗДМ: Интервью с рекрутером накопительные],
			0														AS [ДМЗДМ: Домашнее задание накопительные],
			0														AS [ДМЗДМ: СБ],
			0														AS [ДМЗДМ: Интервью с ДД и РД накопительные],
			0														AS [ДМЗДМ: Медосмотр],
			0														AS [ДМЗДМ: Оформление],
			-- Итоги трудоустройства Валовые
			0														AS [Розница: Принят валовые],
			0														AS [Розница: Мы отказали валовые],
			0														AS [Розница: Не прошел СБ валовые],
			0														AS [Розница: Не прошел СД валовые],
			0														AS [Розница: Отказался валовые],
			0														AS [Розница: Смена вакансии валовые],
			0														AS [Розница: Резерв валовые],
			0														AS [ДМЗДМ: Принят валовые],
			0														AS [ДМЗДМ: Мы отказали валовые],
			0														AS [ДМЗДМ: Не прошел СБ валовые],
			0														AS [ДМЗДМ: Отказался валовые],
			0														AS [ДМЗДМ: Смена вакансии валовые],
			0														AS [ДМЗДМ: Резерв валовые],
			0														AS [Розница: Обработка валовые],
			0														AS [Розница: Интервью с руководителем валовые],
			0														AS [Розница: СБ валовые],
			0														AS [Розница: Медосмотр валовые],
			0														AS [Розница: Оформление валовые],
			0														AS [ДМЗДМ: Обработка валовые],
			0														AS [ДМЗДМ: Интервью с рекрутером валовые],
			0														AS [ДМЗДМ: Домашнее задание валовые],
			0														AS [ДМЗДМ: СБ валовые],
			0														AS [ДМЗДМ: Интервью с ДД и РД валовые],
			0														AS [ДМЗДМ: Медосмотр валовые],
			0														AS [ДМЗДМ: Оформление валовые],
			-- Итоги трудоустройства Поточные 
			0														AS [Розница: Принят по дате кандидата],
			0														AS [Розница: Мы отказали по дате кандидата],
			0														AS [Розница: Не прошел СБ по дате кандидата],
			0														AS [Розница: Не прошел СД по дате кандидата],
			0														AS [Розница: Отказался по дате кандидата],
			0														AS [Розница: Смена вакансии по дате кандидата],
			0														AS [Розница: Резерв по дате кандидата],
			0														AS [ДМЗДМ: Принят по дате кандидата],
			0														AS [ДМЗДМ: Мы отказали по дате кандидата],
			0														AS [ДМЗДМ: Не прошел СБ по дате кандидата],
			0														AS [ДМЗДМ: Отказался по дате кандидата],
			0														AS [ДМЗДМ: Смена вакансии по дате кандидата],
			0														AS [ДМЗДМ: Резерв по дате кандидата],
			-- Этапы трудоустройства Поточные
			0														AS [Розница: Обработка  по дате кандидата],
			0														AS [Розница: Интервью с руководителем по дате кандидата],
			0														AS [Розница: СБ по дате кандидата],
			0														AS [Розница: Медосмотр по дате кандидата],
			0														AS [Розница: Оформление по дате кандидата],
			0														AS [ДМЗДМ: Обработка  по дате кандидата],
			0														AS [ДМЗДМ: Интервью с рекрутером по дате кандидата],
			0														AS [ДМЗДМ: Домашнее задание по дате кандидата],
			0														AS [ДМЗДМ: СБ по дате кандидата],
			0														AS [ДМЗДМ: Интервью с ДД и РД по дате кандидата],
			0														AS [ДМЗДМ: Медосмотр по дате кандидата],
			0														AS [ДМЗДМ: Оформление по дате кандидата]

		FROM [client].[CrmApplicants] A
		LEFT JOIN [client].[CrmPartners] P ON A.[PartnerId] = P.[Id]
		LEFT JOIN [client].[CrmResumeDaxtra] D ON D.[PartnerId] = P.[Id]
		WHERE 
			A.[PartnerId] IS NOT NULL		-- отсеяли чужих соискателей
		GROUP BY P.[CreateDate], D.[AtomId], D.[Version]

		UNION ALL

		SELECT 
			CAST(P.[CreateDate] AS DATETIME)						AS [Дата],
			D.[AtomId]												AS [AtomId],
			D.[Version]												AS [Version],
			0														AS [Розница: Соискатели накопительные],
			0														AS [Розница: Соискатели валовые],
			0														AS [Розница: Кандидаты накопительные],
			0														AS [Розница: Кандидаты валовые],
			0														AS [ДМЗДМ: Соискатели накопительные],
			0														AS [ДМЗДМ: Соискатели валовые],
			0														AS [ДМЗДМ: Кандидаты накопительные],
			0														AS [ДМЗДМ: Кандидаты валовые],
			-- Итоги трудоустройства Накопительные 
			SUM(CASE WHEN L13.[StageId]=144 AND L13.[FunnelId]=8 AND L13.[ResultId]=849 THEN 1 ELSE 0 END)
																	AS [Розница: Принят накопительные],
			0														AS [Розница: Мы отказали накопительные],
			0														AS [Розница: Не прошел СБ накопительные],
			0														AS [Розница: Не прошел СД накопительные],
			0														AS [Розница: Отказался накопительные],
			0														AS [Розница: Смена вакансии накопительные],
			0														AS [Розница: Резерв накопительные],
			SUM(CASE WHEN L14.[StageId]=228 AND L14.[FunnelId]=16 AND L14.[ResultId]=1120 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Принят накопительные],
			0														AS [ДМЗДМ: Мы отказали накопительные],
			0														AS [ДМЗДМ: Не прошел СБ накопительные],
			0														AS [ДМЗДМ: Отказался накопительные],
			0														AS [ДМЗДМ: Смена вакансии накопительные],
			0														AS [ДМЗДМ: Резерв накопительные],
			-- Этапы трудоустройства
			SUM(CASE WHEN L01.[StageId]=139 AND L01.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Обработка  накопительные],
			SUM(CASE WHEN L02.[StageId]=141 AND L02.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Интервью с руководителем накопительные],
			SUM(CASE WHEN L03.[StageId]=142 AND L03.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: СБ],
			SUM(CASE WHEN L04.[StageId]=143 AND L04.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Медосмотр],
			SUM(CASE WHEN L05.[StageId]=144 AND L05.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Оформление],
			SUM(CASE WHEN L06.[StageId]=222 AND L06.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Обработка  накопительные],
			SUM(CASE WHEN L07.[StageId]=223 AND L07.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Интервью с рекрутером накопительные],
			SUM(CASE WHEN L08.[StageId]=224 AND L08.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Домашнее задание накопительные],
			SUM(CASE WHEN L09.[StageId]=225 AND L09.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: СБ],
			SUM(CASE WHEN L10.[StageId]=226 AND L10.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Интервью с ДД и РД накопительные],
			SUM(CASE WHEN L11.[StageId]=227 AND L11.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Медосмотр],
			SUM(CASE WHEN L12.[StageId]=228 AND L12.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Оформление],
			-- Итоги трудоустройства Валовые
			0														AS [Розница: Принят валовые],
			0														AS [Розница: Мы отказали валовые],
			0														AS [Розница: Не прошел СБ валовые],
			0														AS [Розница: Не прошел СД валовые],
			0														AS [Розница: Отказался валовые],
			0														AS [Розница: Смена вакансии валовые],
			0														AS [Розница: Резерв валовые],
			0														AS [ДМЗДМ: Принят валовые],
			0														AS [ДМЗДМ: Мы отказали валовые],
			0														AS [ДМЗДМ: Не прошел СБ валовые],
			0														AS [ДМЗДМ: Отказался валовые],
			0														AS [ДМЗДМ: Смена вакансии валовые],
			0														AS [ДМЗДМ: Резерв валовые],
			0														AS [Розница: Обработка валовые],
			0														AS [Розница: Интервью с руководителем валовые],
			0														AS [Розница: СБ валовые],
			0														AS [Розница: Медосмотр валовые],
			0														AS [Розница: Оформление валовые],
			0														AS [ДМЗДМ: Обработка валовые],
			0														AS [ДМЗДМ: Интервью с рекрутером валовые],
			0														AS [ДМЗДМ: Домашнее задание валовые],
			0														AS [ДМЗДМ: СБ валовые],
			0														AS [ДМЗДМ: Интервью с ДД и РД валовые],
			0														AS [ДМЗДМ: Медосмотр валовые],
			0														AS [ДМЗДМ: Оформление валовые],
			-- Итоги трудоустройства Поточные 
			0														AS [Розница: Принят по дате кандидата],
			0														AS [Розница: Мы отказали по дате кандидата],
			0														AS [Розница: Не прошел СБ по дате кандидата],
			0														AS [Розница: Не прошел СД по дате кандидата],
			0														AS [Розница: Отказался по дате кандидата],
			0														AS [Розница: Смена вакансии по дате кандидата],
			0														AS [Розница: Резерв по дате кандидата],
			0														AS [ДМЗДМ: Принят по дате кандидата],
			0														AS [ДМЗДМ: Мы отказали по дате кандидата],
			0														AS [ДМЗДМ: Не прошел СБ по дате кандидата],
			0														AS [ДМЗДМ: Отказался по дате кандидата],
			0														AS [ДМЗДМ: Смена вакансии по дате кандидата],
			0														AS [ДМЗДМ: Резерв по дате кандидата],
			-- Этапы трудоустройства Поточные
			0														AS [Розница: Обработка  по дате кандидата],
			0														AS [Розница: Интервью с руководителем по дате кандидата],
			0														AS [Розница: СБ по дате кандидата],
			0														AS [Розница: Медосмотр по дате кандидата],
			0														AS [Розница: Оформление по дате кандидата],
			0														AS [ДМЗДМ: Обработка  по дате кандидата],
			0														AS [ДМЗДМ: Интервью с рекрутером по дате кандидата],
			0														AS [ДМЗДМ: Домашнее задание по дате кандидата],
			0														AS [ДМЗДМ: СБ по дате кандидата],
			0														AS [ДМЗДМ: Интервью с ДД и РД по дате кандидата],
			0														AS [ДМЗДМ: Медосмотр по дате кандидата],
			0														AS [ДМЗДМ: Оформление по дате кандидата]

		FROM [client].[CrmApplicants] A
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=139 AND [FunnelId]=8
		) L01 ON A.[Id] = L01.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=141 AND [FunnelId]=8
		) L02 ON A.[Id] = L02.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=142 AND [FunnelId]=8
		) L03 ON A.[Id] = L03.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=143 AND [FunnelId]=8
		) L04 ON A.[Id] = L04.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=144 AND [FunnelId]=8 AND [ResultId]<>849
		) L05 ON A.[Id] = L05.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=222 AND [FunnelId]=6
		) L06 ON A.[Id] = L06.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=223 AND [FunnelId]=6
		) L07 ON A.[Id] = L07.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=224 AND [FunnelId]=6
		) L08 ON A.[Id] = L08.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=225 AND [FunnelId]=6
		) L09 ON A.[Id] = L09.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=226 AND [FunnelId]=6
		) L10 ON A.[Id] = L10.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=227 AND [FunnelId]=6
		) L11 ON A.[Id] = L11.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=228 AND [FunnelId]=16 AND [ResultId]<>1120
		) L12 ON A.[Id] = L12.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId], [ResultId]
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=144 AND [FunnelId]=8 AND [ResultId]=849
		) L13 ON A.[Id] = L13.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId], [ResultId]
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=228 AND [FunnelId]=16 AND [ResultId]=1120
		) L14 ON A.[Id] = L14.[ApplicantId] 
		LEFT JOIN [client].[CrmPartners] P ON A.[PartnerId] = P.[Id]
		LEFT JOIN [client].[CrmResumeDaxtra] D ON D.[PartnerId] = P.[Id]
		WHERE 
			A.[PartnerId] IS NOT NULL		-- отсеяли чужих соискателей
		GROUP BY P.[CreateDate], D.[AtomId], D.[Version]

				UNION ALL

		SELECT 
			CAST(A.[DateLastStageUpdate] AS DATETIME)				AS [Дата],
			D.[AtomId]												AS [AtomId],
			D.[Version]												AS [Version],
			0														AS [Розница: Соискатели накопительные],
			0														AS [Розница: Соискатели валовые],
			0														AS [Розница: Кандидаты накопительные],
			0														AS [Розница: Кандидаты валовые],
			0														AS [ДМЗДМ: Соискатели накопительные],
			0														AS [ДМЗДМ: Соискатели валовые],
			0														AS [ДМЗДМ: Кандидаты накопительные],
			0														AS [ДМЗДМ: Кандидаты валовые],
			-- Итоги трудоустройства Накопительные 
			0														AS [Розница: Принят накопительные],
			0														AS [Розница: Мы отказали накопительные],
			0														AS [Розница: Не прошел СБ накопительные],
			0														AS [Розница: Не прошел СД накопительные],
			0														AS [Розница: Отказался накопительные],
			0														AS [Розница: Смена вакансии накопительные],
			0														AS [Розница: Резерв накопительные],
			0														AS [ДМЗДМ: Принят накопительные],
			0														AS [ДМЗДМ: Мы отказали накопительные],
			0														AS [ДМЗДМ: Не прошел СБ накопительные],
			0														AS [ДМЗДМ: Отказался накопительные],
			0														AS [ДМЗДМ: Смена вакансии накопительные],
			0														AS [ДМЗДМ: Резерв накопительные],
			-- Этапы трудоустройства
			0														AS [Розница: Обработка  накопительные],
			0														AS [Розница: Интервью с руководителем накопительные],
			0														AS [Розница: СБ],
			0														AS [Розница: Медосмотр],
			0														AS [Розница: Оформление],
			0														AS [ДМЗДМ: Обработка  накопительные],
			0														AS [ДМЗДМ: Интервью с рекрутером накопительные],
			0														AS [ДМЗДМ: Домашнее задание накопительные],
			0														AS [ДМЗДМ: СБ],
			0														AS [ДМЗДМ: Интервью с ДД и РД накопительные],
			0														AS [ДМЗДМ: Медосмотр],
			0														AS [ДМЗДМ: Оформление],
			-- Итоги трудоустройства Валовые
			SUM(CASE WHEN L01.[StageId]=144 AND L01.[FunnelId]=8 AND L01.[ResultId]=849 THEN 1 ELSE 0 END)
																	AS [Розница: Принят валовые],
			SUM(CASE WHEN A.[StageId]=147 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Мы отказали валовые],
			SUM(CASE WHEN A.[StageId]=150 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Не прошел СБ валовые],
			SUM(CASE WHEN A.[StageId]=249 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Не прошел СД валовые],
			SUM(CASE WHEN A.[StageId]=146 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Отказался валовые],
			SUM(CASE WHEN A.[StageId]=151 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Смена вакансии валовые],
			SUM(CASE WHEN A.[StageId]=149 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Резерв валовые],
			SUM(CASE WHEN L02.[StageId]=228 AND L02.[FunnelId]=16 AND L02.[ResultId]=1120 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Принят валовые],
			SUM(CASE WHEN A.[StageId]=233 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Мы отказали валовые],
			SUM(CASE WHEN A.[StageId]=236 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Не прошел СБ валовые],
			SUM(CASE WHEN A.[StageId]=231 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Отказался валовые],
			SUM(CASE WHEN A.[StageId]=237 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Смена вакансии валовые],
			SUM(CASE WHEN A.[StageId]=235 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Резерв валовые],
			SUM(CASE WHEN A.[StageId]=139 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Обработка валовые],
			SUM(CASE WHEN A.[StageId]=141 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Интервью с руководителем валовые],
			SUM(CASE WHEN A.[StageId]=142 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: СБ валовые],
			SUM(CASE WHEN A.[StageId]=143 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Медосмотр валовые],
			SUM(CASE WHEN A.[StageId]=144 AND A.[FunnelId]=8 AND L01.[ResultId] IS NULL AND L01.[StageId] IS NULL THEN 1 ELSE 0 END)
																	AS [Розница: Оформление валовые],
			SUM(CASE WHEN A.[StageId]=222 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Обработка валовые],
			SUM(CASE WHEN A.[StageId]=223 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Интервью с рекрутером валовые],
			SUM(CASE WHEN A.[StageId]=224 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Домашнее задание валовые],
			SUM(CASE WHEN A.[StageId]=225 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: СБ валовые],
			SUM(CASE WHEN A.[StageId]=226 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Интервью с ДД и РД валовые],
			SUM(CASE WHEN A.[StageId]=227 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Медосмотр валовые],
			SUM(CASE WHEN A.[StageId]=228 AND A.[FunnelId]=16 AND L02.[ResultId] IS NULL AND L02.[StageId] IS NULL THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Оформление валовые],
			-- Итоги трудоустройства Поточные 
			0														AS [Розница: Принят по дате кандидата],
			0														AS [Розница: Мы отказали по дате кандидата],
			0														AS [Розница: Не прошел СБ по дате кандидата],
			0														AS [Розница: Не прошел СД по дате кандидата],
			0														AS [Розница: Отказался по дате кандидата],
			0														AS [Розница: Смена вакансии по дате кандидата],
			0														AS [Розница: Резерв по дате кандидата],
			0														AS [ДМЗДМ: Принят по дате кандидата],
			0														AS [ДМЗДМ: Мы отказали по дате кандидата],
			0														AS [ДМЗДМ: Не прошел СБ по дате кандидата],
			0														AS [ДМЗДМ: Отказался по дате кандидата],
			0														AS [ДМЗДМ: Смена вакансии по дате кандидата],
			0														AS [ДМЗДМ: Резерв по дате кандидата],
			-- Этапы трудоустройства Поточные
			0														AS [Розница: Обработка  по дате кандидата],
			0														AS [Розница: Интервью с руководителем по дате кандидата],
			0														AS [Розница: СБ по дате кандидата],
			0														AS [Розница: Медосмотр по дате кандидата],
			0														AS [Розница: Оформление по дате кандидата],
			0														AS [ДМЗДМ: Обработка  по дате кандидата],
			0														AS [ДМЗДМ: Интервью с рекрутером по дате кандидата],
			0														AS [ДМЗДМ: Домашнее задание по дате кандидата],
			0														AS [ДМЗДМ: СБ по дате кандидата],
			0														AS [ДМЗДМ: Интервью с ДД и РД по дате кандидата],
			0														AS [ДМЗДМ: Медосмотр по дате кандидата],
			0														AS [ДМЗДМ: Оформление по дате кандидата]

		FROM [client].[CrmApplicants] A
		LEFT JOIN (
			SELECT [ApplicantId], [StageId], [FunnelId], [ResultId]
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=144 AND [FunnelId]=8 AND [ResultId]=849
		) L01 ON A.[Id] = L01.[ApplicantId] 
		LEFT JOIN (
			SELECT [ApplicantId], [StageId], [FunnelId], [ResultId]
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=228 AND [FunnelId]=16 AND [ResultId]=1120
		) L02 ON A.[Id] = L02.[ApplicantId] 
		LEFT JOIN [client].[CrmPartners] P ON A.[PartnerId] = P.[Id]
		LEFT JOIN [client].[CrmResumeDaxtra] D ON D.[PartnerId] = P.[Id]
		WHERE 
			A.[PartnerId] IS NOT NULL		-- отсеяли чужих соискателей
		GROUP BY A.[DateLastStageUpdate], D.[AtomId], D.[Version]

		UNION ALL

		SELECT 
			CAST(A.[CreateDate] AS DATETIME)						AS [Дата],
			D.[AtomId]												AS [AtomId],
			D.[Version]												AS [Version],
			0														AS [Розница: Соискатели накопительные],
			0														AS [Розница: Соискатели валовые],
			0														AS [Розница: Кандидаты накопительные],
			0														AS [Розница: Кандидаты валовые],
			0														AS [ДМЗДМ: Соискатели накопительные],
			0														AS [ДМЗДМ: Соискатели валовые],
			0														AS [ДМЗДМ: Кандидаты накопительные],
			0														AS [ДМЗДМ: Кандидаты валовые],
			-- Итоги трудоустройства Накопительные 
			0														AS [Розница: Принят накопительные],
			0														AS [Розница: Мы отказали накопительные],
			0														AS [Розница: Не прошел СБ накопительные],
			0														AS [Розница: Не прошел СД накопительные],
			0														AS [Розница: Отказался накопительные],
			0														AS [Розница: Смена вакансии накопительные],
			0														AS [Розница: Резерв накопительные],
			0														AS [ДМЗДМ: Принят накопительные],
			0														AS [ДМЗДМ: Мы отказали накопительные],
			0														AS [ДМЗДМ: Не прошел СБ накопительные],
			0														AS [ДМЗДМ: Отказался накопительные],
			0														AS [ДМЗДМ: Смена вакансии накопительные],
			0														AS [ДМЗДМ: Резерв накопительные],
			-- Этапы трудоустройства
			0														AS [Розница: Обработка  накопительные],
			0														AS [Розница: Интервью с руководителем накопительные],
			0														AS [Розница: СБ],
			0														AS [Розница: Медосмотр],
			0														AS [Розница: Оформление],
			0														AS [ДМЗДМ: Обработка  накопительные],
			0														AS [ДМЗДМ: Интервью с рекрутером накопительные],
			0														AS [ДМЗДМ: Домашнее задание накопительные],
			0														AS [ДМЗДМ: СБ],
			0														AS [ДМЗДМ: Интервью с ДД и РД накопительные],
			0														AS [ДМЗДМ: Медосмотр],
			0														AS [ДМЗДМ: Оформление],
			-- Итоги трудоустройства Валовые
			0														AS [Розница: Принят валовые],
			0														AS [Розница: Мы отказали валовые],
			0														AS [Розница: Не прошел СБ валовые],
			0														AS [Розница: Не прошел СД валовые],
			0														AS [Розница: Отказался валовые],
			0														AS [Розница: Смена вакансии валовые],
			0														AS [Розница: Резерв валовые],
			0														AS [ДМЗДМ: Принят валовые],
			0														AS [ДМЗДМ: Мы отказали валовые],
			0														AS [ДМЗДМ: Не прошел СБ валовые],
			0														AS [ДМЗДМ: Отказался валовые],
			0														AS [ДМЗДМ: Смена вакансии валовые],
			0														AS [ДМЗДМ: Резерв валовые],
			0														AS [Розница: Обработка валовые],
			0														AS [Розница: Интервью с руководителем валовые],
			0														AS [Розница: СБ валовые],
			0														AS [Розница: Медосмотр валовые],
			0														AS [Розница: Оформление валовые],
			0														AS [ДМЗДМ: Обработка валовые],
			0														AS [ДМЗДМ: Интервью с рекрутером валовые],
			0														AS [ДМЗДМ: Домашнее задание валовые],
			0														AS [ДМЗДМ: СБ валовые],
			0														AS [ДМЗДМ: Интервью с ДД и РД валовые],
			0														AS [ДМЗДМ: Медосмотр валовые],
			0														AS [ДМЗДМ: Оформление валовые],
			-- Итоги трудоустройства Поточные 
			SUM(CASE WHEN L13.[StageId]=144 AND L13.[FunnelId]=8 AND L13.[ResultId]=849 THEN 1 ELSE 0 END)
																	AS [Розница: Принят по дате кандидата],
			SUM(CASE WHEN A.[StageId]=147 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Мы отказали по дате кандидата],
			SUM(CASE WHEN A.[StageId]=150 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Не прошел СБ по дате кандидата],
			SUM(CASE WHEN A.[StageId]=249 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Не прошел СД по дате кандидата],
			SUM(CASE WHEN A.[StageId]=146 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Отказался по дате кандидата],
			SUM(CASE WHEN A.[StageId]=151 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Смена вакансии по дате кандидата],
			SUM(CASE WHEN A.[StageId]=149 AND A.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Резерв по дате кандидата],
			SUM(CASE WHEN L14.[StageId]=228 AND L14.[FunnelId]=16 AND L14.[ResultId]=1120 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Принят по дате кандидата],
			SUM(CASE WHEN A.[StageId]=233 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Мы отказали по дате кандидата],
			SUM(CASE WHEN A.[StageId]=236 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Не прошел СБ по дате кандидата],
			SUM(CASE WHEN A.[StageId]=231 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Отказался по дате кандидата],
			SUM(CASE WHEN A.[StageId]=237 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Смена вакансии по дате кандидата],
			SUM(CASE WHEN A.[StageId]=235 AND A.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Резерв по дате кандидата],
			-- Этапы трудоустройства Поточные
			SUM(CASE WHEN L01.[StageId]=139 AND L01.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Обработка  по дате кандидата],
			SUM(CASE WHEN L02.[StageId]=141 AND L02.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Интервью с руководителем по дате кандидата],
			SUM(CASE WHEN L03.[StageId]=142 AND L03.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: СБ по дате кандидата],
			SUM(CASE WHEN L04.[StageId]=143 AND L04.[FunnelId]=8 THEN 1 ELSE 0 END)
																	AS [Розница: Медосмотр по дате кандидата],
			SUM(CASE WHEN L05.[StageId]=144 AND L05.[FunnelId]=8 AND L05.[ResultId]<>849 THEN 1 ELSE 0 END)
																	AS [Розница: Оформление по дате кандидата],
			SUM(CASE WHEN L06.[StageId]=222 AND L06.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Обработка  по дате кандидата],
			SUM(CASE WHEN L07.[StageId]=223 AND L07.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Интервью с рекрутером по дате кандидата],
			SUM(CASE WHEN L08.[StageId]=224 AND L08.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Домашнее задание по дате кандидата],
			SUM(CASE WHEN L09.[StageId]=225 AND L09.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: СБ по дате кандидата],
			SUM(CASE WHEN L10.[StageId]=226 AND L10.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Интервью с ДД и РД по дате кандидата],
			SUM(CASE WHEN L11.[StageId]=227 AND L11.[FunnelId]=16 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Медосмотр по дате кандидата],
			SUM(CASE WHEN L12.[StageId]=228 AND L12.[FunnelId]=16 AND L12.[ResultId]<>1120 THEN 1 ELSE 0 END)
																	AS [ДМЗДМ: Оформление по дате кандидата]

		FROM [client].[CrmApplicants] A
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=139 AND [FunnelId]=8
		) L01 ON A.[Id] = L01.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=141 AND [FunnelId]=8
		) L02 ON A.[Id] = L02.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=142 AND [FunnelId]=8
		) L03 ON A.[Id] = L03.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=143 AND [FunnelId]=8
		) L04 ON A.[Id] = L04.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId], [ResultId]
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=144 AND [FunnelId]=8 AND [ResultId]<>849
		) L05 ON A.[Id] = L05.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=222 AND [FunnelId]=6
		) L06 ON A.[Id] = L06.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=223 AND [FunnelId]=6
		) L07 ON A.[Id] = L07.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=224 AND [FunnelId]=6
		) L08 ON A.[Id] = L08.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=225 AND [FunnelId]=6
		) L09 ON A.[Id] = L09.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=226 AND [FunnelId]=6
		) L10 ON A.[Id] = L10.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId] 
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=227 AND [FunnelId]=6
		) L11 ON A.[Id] = L11.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId], [ResultId]
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=228 AND [FunnelId]=16 AND [ResultId]<>1120
		) L12 ON A.[Id] = L12.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId], [ResultId]
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=144 AND [FunnelId]=8 AND [ResultId]=849
		) L13 ON A.[Id] = L13.[ApplicantId] 
		LEFT JOIN (
			SELECT DISTINCT [ApplicantId], [StageId], [FunnelId], [ResultId]
			FROM [client].[CrmLog] WHERE [State]!='cancel' AND [StageId]=228 AND [FunnelId]=16 AND [ResultId]=1120
		) L14 ON A.[Id] = L14.[ApplicantId] 
		LEFT JOIN [client].[CrmPartners] P ON A.[PartnerId] = P.[Id]
		LEFT JOIN [client].[CrmResumeDaxtra] D ON D.[PartnerId] = P.[Id]
		WHERE 
			A.[PartnerId] IS NOT NULL		-- отсеяли чужих соискателей
		GROUP BY A.[CreateDate], D.[AtomId], D.[Version]

) AS t1
GROUP BY	[Дата], [AtomId], [Version]
GO



SELECT
	SUM(t1.[Розница: Кандидаты накопительные]) AS [Розница: Кандидаты накопительные]
FROM [pivotparts].[Crm3] AS T1



WITH FirstApplicants
AS
(
	SELECT	* 
	FROM	(
			SELECT	*, ROW_NUMBER() OVER (PARTITION BY [PartnerId] ORDER BY [CreateDate]) AS [RowNum] 
			FROM	[client].[CrmApplicants]
			) AS A
	WHERE [RowNum] = 1
)

		SELECT DISTINCT L.Id, L.[ApplicantId], A.ID AID, Fa.Id FAID, P.Id PID, D.AtomId, FA.AtomId
		FROM [client].[CrmLog] L
		LEFT JOIN [client].[CrmApplicants] A ON A.[Id] = L.[ApplicantId]
		LEFT JOIN FirstApplicants FA ON FA.[Id] = L.[ApplicantId]
		LEFT JOIN [client].[CrmPartners] P ON COALESCE(A.[PartnerId], FA.[PartnerId]) = P.[Id]
		LEFT JOIN [client].[CrmResumeDaxtra] D ON D.[PartnerId] = P.[Id]
		WHERE L.[State]!='cancel' AND L.[StageId]=144 AND L.[FunnelId]=8 AND L.[ResultId]=849


